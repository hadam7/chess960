@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthStateProvider
@inject ClientFriendService FriendService
@inject NavigationManager Nav
@rendermode InteractiveWebAssembly

<div class="space-y-8 animate-soft-up">
    <!-- Hero / Welcome -->
    <div class="flex flex-col md:flex-row justify-between items-center gap-6">
        <div>
            <h1 class="text-3xl font-display font-bold text-white">
                Hi, <span class="text-transparent bg-clip-text bg-gradient-to-r from-theme-accent to-theme-glow">@username</span>! ðŸ‘‹
            </h1>
            <p class="text-theme-muted mt-2">Ready for another game?</p>
        </div>
        
        <!-- Stats Mini-Grid -->
        <div class="flex gap-4">
             <div class="px-6 py-3 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md flex flex-col items-center min-w-[100px]">
                 <span class="text-xs font-bold text-theme-muted uppercase tracking-wider">Rating</span>
                 <span class="text-2xl font-mono font-bold text-theme-accent">@eloRating</span>
             </div>
             <div class="px-6 py-3 rounded-xl bg-white/5 border border-white/10 backdrop-blur-md flex flex-col items-center min-w-[100px]">
                 <span class="text-xs font-bold text-theme-muted uppercase tracking-wider">Matches</span>
                 <span class="text-2xl font-mono font-bold text-white">@gamesPlayed</span>
             </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Play Bot (Neutral/Glass) -->
        <button @onclick='() => Nav.NavigateTo("play-bot")' 
                class="group relative overflow-hidden rounded-2xl bg-white/5 border border-white/10 p-6 text-left transition-all hover:scale-[1.02] hover:bg-white/10 hover:shadow-[0_0_30px_rgba(255,255,255,0.1)]">
            <div class="absolute right-0 top-0 h-32 w-32 -mr-8 -mt-8 rounded-full bg-white/5 blur-2xl transition-all group-hover:bg-white/10"></div>
            <span class="bi bi-robot text-4xl text-white mb-4 block relative z-10"></span>
            <div class="relative z-10">
                <h3 class="text-xl font-bold text-white">Play vs Bot</h3>
                <p class="text-sm text-theme-muted mt-1">Practice against Stockfish without stakes.</p>
            </div>
        </button>

        <!-- Play Online (Theme Accent) -->
        <button @onclick='() => Nav.NavigateTo("play-online")' 
                class="group relative overflow-hidden rounded-2xl bg-gradient-to-br from-theme-accent/20 to-theme-accent/5 border border-theme-accent/30 p-6 text-left transition-all hover:scale-[1.02] hover:shadow-[0_0_30px_rgba(var(--color-accent),0.2)]">
            <div class="absolute right-0 top-0 h-32 w-32 -mr-8 -mt-8 rounded-full bg-theme-accent/10 blur-2xl transition-all group-hover:bg-theme-accent/20"></div>
            <span class="bi bi-globe text-4xl text-theme-accent mb-4 block relative z-10"></span>
            <div class="relative z-10">
                <h3 class="text-xl font-bold text-white">Play Online</h3>
                <p class="text-sm text-theme-accent/60 mt-1">Find an opponent and climb the ranks.</p>
            </div>
        </button>

        <!-- Friends (Theme Glow) -->
        <button @onclick='() => Nav.NavigateTo("friends")' 
                class="group relative overflow-hidden rounded-2xl bg-gradient-to-br from-theme-glow/20 to-theme-glow/5 border border-theme-glow/30 p-6 text-left transition-all hover:scale-[1.02] hover:shadow-[0_0_30px_rgba(var(--color-glow),0.2)]">
            <div class="absolute right-0 top-0 h-32 w-32 -mr-8 -mt-8 rounded-full bg-theme-glow/10 blur-2xl transition-all group-hover:bg-theme-glow/20"></div>
            <span class="bi bi-people-fill text-4xl text-theme-glow mb-4 block relative z-10"></span>
            <div class="relative z-10">
                <h3 class="text-xl font-bold text-white">Friends</h3>
                <p class="text-sm text-theme-glow/60 mt-1">Manage your friends list and challenge them.</p>
            </div>
        </button>
    </div>





    <!-- Recent Activity -->
    <div class="glass-panel p-6">
        <h3 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span class="bi bi-clock-history text-theme-accent"></span> Recent Activity
        </h3>

        @if (recentGames == null)
        {
             <div class="animate-pulse space-y-3">
                <div class="h-10 bg-white/5 rounded"></div>
                <div class="h-10 bg-white/5 rounded"></div>
            </div>
        }
        else if (recentGames.Any())
        {
            <div class="overflow-x-auto">
                <table class="w-full text-left text-sm">
                    <thead>
                        <tr class="text-xs text-theme-muted uppercase border-b border-white/10">
                            <th class="pb-3 pl-2">Time</th>
                            <th class="pb-3 pl-2">Opponent</th>
                            <th class="pb-3 text-center">Result</th>
                            <th class="pb-3 text-right pr-2">Date</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-white/5">
                        @foreach (var game in recentGames)
                        {
                            <tr class="hover:bg-white/5 transition-colors cursor-pointer" @onclick='() => Nav.NavigateTo($"/replay/{game.Id}")'>
                                <td class="py-3 pl-2">
                                    <div class="flex items-center gap-2" title="@game.TimeControl">
                                        <span class="@GetTimeIconClass(game.TimeControl)"></span>
                                        <span class="text-xs font-bold text-white/70">@GetFormattedTime(game.TimeControl)</span>
                                    </div>
                                </td>
                                <td class="py-3 pl-2 font-bold text-white">
                                    @game.OpponentName
                                </td>
                                <td class="py-3 text-center">
                                    @if(game.Result == "Won")
                                    {
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-green-500/20 text-green-400 text-xs font-bold border border-green-500/30">
                                            <span class="bi bi-trophy-fill"></span> WON
                                        </span>
                                    }
                                    else if(game.Result == "Lost")
                                    {
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-red-500/20 text-red-400 text-xs font-bold border border-red-500/30">
                                            <span class="bi bi-x-circle-fill"></span> LOST
                                        </span>
                                    }
                                    else
                                    {
                                        <span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-gray-500/20 text-gray-400 text-xs font-bold border border-gray-500/30">
                                            <span class="bi bi-circle-half"></span> DRAW
                                        </span>
                                    }
                                </td>
                                <td class="py-3 text-right pr-2 text-theme-muted text-xs">
                                    @game.DatePlayed.ToLocalTime().ToString("MMM dd, HH:mm")
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
        else
        {
            <div class="text-theme-muted text-sm italic">
                No games played yet.
            </div>
        }
    </div>
</div>

@inject HttpClient Http
@using System.Net.Http.Headers

@code {
    private string username = "Player";
    private int eloRating = 1200;
    private int gamesPlayed = 0;

    private List<GameHistoryDto>? recentGames;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            // Fetch User Details including Stats
            try 
            {
                var userStats = await Http.GetFromJsonAsync<UserDto>("api/user/me");
                if (userStats != null)
                {
                    username = userStats.UserName;
                    eloRating = userStats.EloRating;
                    gamesPlayed = userStats.GamesPlayed;
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching user stats: {ex.Message}");
                // Fallback to claims if API fails
                 username = user.Identity.Name ?? "Player";
            }



            // Load History
            try
            {
                recentGames = await Http.GetFromJsonAsync<List<GameHistoryDto>>("api/user/history");
            }
            catch (Exception ex)
            {
                 Console.WriteLine($"Error fetching history: {ex.Message}");
                 recentGames = new();
            }
        }

    }

    private string GetTimeIconClass(string tc)
    {
        if (string.IsNullOrEmpty(tc)) return "bi bi-question-circle text-gray-500";
        
        var parts = tc.Split('+');
        if (parts.Length > 0 && double.TryParse(parts[0], out double timeVal))
        {
            // If time is large (>= 60), assume seconds. If small (< 60), assume minutes.
            double totalMinutes = timeVal >= 60 ? timeVal / 60 : timeVal;

            if (totalMinutes < 3) return "bi bi-rocket-takeoff-fill text-yellow-400"; // Bullet (< 3m) -> Rocket
            if (totalMinutes < 10) return "bi bi-lightning-fill text-amber-500"; // Blitz (3-9m) -> Lightning
            return "bi bi-stopwatch-fill text-emerald-400"; // Rapid (>= 10m) -> Stopwatch
        }
        return "bi bi-hourglass text-gray-400";
    }

    private string GetFormattedTime(string tc)
    {
        if (string.IsNullOrEmpty(tc)) return "-";
        
        var parts = tc.Split('+');
        if (parts.Length > 0 && double.TryParse(parts[0], out double timeVal))
        {
            double totalMinutes = timeVal >= 60 ? timeVal / 60 : timeVal;
            string increment = parts.Length > 1 ? parts[1] : "0";

            if (increment == "0") return $"{totalMinutes}";
            return $"{totalMinutes}|{increment}";
        }
        return tc.Replace("+", "|");
    }
}

