@using Chess960.Web.Client.Services
@inject ChessGameService GameService
@implements IDisposable

<div class="flex flex-col items-center gap-4">
    <div class="w-full max-w-[600px] aspect-square bg-[#ebecd0] rounded-lg shadow-xl overflow-hidden border-4 border-[#779556]">
        <div class="grid grid-cols-8 grid-rows-8 h-full w-full">
            @for (int rank = 7; rank >= 0; rank--)
            {
                @for (int file = 0; file < 8; file++)
                {
                    var localRank = rank;
                    var localFile = file;
                    var isLightSquare = (localRank + localFile) % 2 != 0;
                    var squareColor = isLightSquare ? "bg-[#ebecd0]" : "bg-[#779556]";
                    var piece = GetPieceAt(localFile, localRank);
                    var isSelected = selectedSquare == (localFile, localRank);
                    
                    <div class="@squareColor relative flex items-center justify-center @(isSelected ? "ring-4 ring-yellow-400 ring-inset" : "")"
                         @onclick="() => HandleSquareClick(localFile, localRank)">
                        
                        @* Coordinate labels *@
                        @if (file == 0)
                        {
                            <span class="absolute top-0.5 left-0.5 text-[10px] font-bold @(isLightSquare ? "text-[#779556]" : "text-[#ebecd0]")">
                                @(rank + 1)
                            </span>
                        }
                        @if (rank == 0)
                        {
                            <span class="absolute bottom-0.5 right-0.5 text-[10px] font-bold @(isLightSquare ? "text-[#779556]" : "text-[#ebecd0]")">
                                @((char)('a' + file))
                            </span>
                        }

                        @if (piece != ' ')
                        {
                            <ChessPiece PieceType="@char.ToUpper(piece)" 
                                        IsWhite="@char.IsUpper(piece)" 
                                        Class="w-4/5 h-4/5 transition-transform hover:scale-110" />
                        }
                    </div>
                }
            }
        </div>
    </div>
    
    <div class="flex gap-2">
        <button @onclick="() => StartNewGame(false)" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            Standard Chess
        </button>
        <button @onclick="() => StartNewGame(true)" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition">
            Chess960
        </button>
    </div>
</div>

@code {
    private (int file, int rank)? selectedSquare;
    
    protected override void OnInitialized()
    {
        GameService.OnStateChanged += StateHasChanged;
    }

    public void Dispose()
    {
        GameService.OnStateChanged -= StateHasChanged;
    }

    private void StartNewGame(bool is960)
    {
        GameService.StartNewGame(is960);
        selectedSquare = null;
    }

    private char GetPieceAt(int file, int rank)
    {
        // Rudzoft.ChessLib uses 0-63 index, usually rank-major or file-major.
        // Let's check the FEN string to be safe and simple for rendering.
        // FEN ranks are 8 to 1.
        
        var fen = GameService.GetFen();
        if (string.IsNullOrEmpty(fen)) return ' ';

        var parts = fen.Split(' ');
        var ranks = parts[0].Split('/');
        
        if (ranks.Length != 8) return ' ';

        var rankString = ranks[7 - rank]; // FEN starts at rank 8 (index 0)
        
        int currentFile = 0;
        foreach (var c in rankString)
        {
            if (char.IsDigit(c))
            {
                currentFile += (int)char.GetNumericValue(c);
            }
            else
            {
                if (currentFile == file) return c;
                currentFile++;
            }
        }
        return ' ';
    }

    private void HandleSquareClick(int file, int rank)
    {
        if (selectedSquare == null)
        {
            // Select piece
            var piece = GetPieceAt(file, rank);
            if (piece != ' ')
            {
                selectedSquare = (file, rank);
            }
        }
        else
        {
            // Move logic placeholder
            var from = $"{(char)('a' + selectedSquare.Value.file)}{selectedSquare.Value.rank + 1}";
            var to = $"{(char)('a' + file)}{rank + 1}";
            
            Console.WriteLine($"Attempt move: {from} -> {to}");
            
            // TODO: Call GameService.MakeMove(from, to)
            
            selectedSquare = null;
        }
    }
}
