@using Chess960.Web.Client.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject MultiplayerService Multiplayer
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@implements IDisposable
@rendermode InteractiveWebAssembly

<!-- Global Toast Container (Top Right) -->
<div class="fixed top-4 right-4 z-[9999] flex flex-col gap-2 w-full max-w-sm pointer-events-none">
    @foreach (var challenge in activeChallenges)
    {
        <div class="pointer-events-auto bg-[#1a1a1a]/90 backdrop-blur-md border border-theme-accent/30 rounded-xl shadow-2xl p-4 animate-in slide-in-from-right-full duration-300 flex flex-col gap-2 relative overflow-hidden group">
            <div class="absolute left-0 top-0 bottom-0 w-1 bg-theme-accent"></div>
            
            <div class="flex items-start justify-between">
                <div>
                    <h4 class="text-white font-bold text-sm uppercase tracking-wide flex items-center gap-2">
                        <span class="bi bi-lightning-charge-fill text-theme-accent animate-pulse"></span>
                        Kihívás Érkezett!
                    </h4>
                    <p class="text-xs text-theme-muted mt-1">
                        <span class="text-white font-bold">@challenge.RequesterName</span> kihívott egy 
                        <span class="font-mono text-theme-accent">@challenge.TimeControl</span> meccsre.
                    </p>
                </div>
                <button @onclick="@(() => DismissChallenge(challenge))" class="text-white/30 hover:text-white transition-colors">
                    <span class="bi bi-x-lg"></span>
                </button>
            </div>
            
            <div class="flex gap-2 mt-2">
                <button @onclick="@(() => AcceptChallenge(challenge))" class="flex-1 bg-theme-accent text-black text-xs font-bold py-2 rounded hover:scale-105 transition-transform shadow-lg uppercase tracking-wider">
                    Elfogad
                </button>
                <button @onclick="@(() => DismissChallenge(challenge))" class="flex-1 bg-white/10 text-white text-xs font-bold py-2 rounded hover:bg-white/20 transition-colors uppercase tracking-wider">
                    Elutasít
                </button>
            </div>
        </div>
    }
</div>

@code {
    private List<ChallengeNotification> activeChallenges = new();

    private record ChallengeNotification(string RequesterId, string RequesterName, string TimeControl);

    protected override void OnInitialized()
    {
        Multiplayer.OnChallengeReceived += HandleChallengeReceived;
        Multiplayer.OnGameStarted += HandleGameStarted;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Ensure Global Connection
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                if (Multiplayer.MyConnectionId == null)
                {
                    var userIdClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) ?? user.FindFirst("sub");
                    if (userIdClaim != null)
                    {
                        Multiplayer.UserId = userIdClaim.Value;
                        await Multiplayer.InitializeAsync();
                    }
                }
            }
        }
    }

    public void Dispose()
    {
        Multiplayer.OnChallengeReceived -= HandleChallengeReceived;
        Multiplayer.OnGameStarted -= HandleGameStarted;
    }

    private void HandleChallengeReceived(string requesterId, string requesterName, string timeControl)
    {
        Console.WriteLine($"[NotificationTheCenter] Challenge Received from {requesterName} ({requesterId})!");
        activeChallenges.Add(new ChallengeNotification(requesterId, requesterName, timeControl));
        InvokeAsync(StateHasChanged);
        
        // Auto-dismiss after 15 seconds?
        _ = Task.Delay(15000).ContinueWith(_ => 
        {
             var c = activeChallenges.FirstOrDefault(x => x.RequesterId == requesterId);
             if (c != null) 
             {
                 activeChallenges.Remove(c);
                 InvokeAsync(StateHasChanged);
             }
        });
    }

    private async Task AcceptChallenge(ChallengeNotification challenge)
    {
        await Multiplayer.RespondToChallengeAsync(challenge.RequesterId, true, challenge.TimeControl);
        activeChallenges.Remove(challenge);
    }

    private void DismissChallenge(ChallengeNotification challenge)
    {
        activeChallenges.Remove(challenge);
        // Optional: Send decline to server
    }

    private void HandleGameStarted(string gameId, string fen, string whiteId, string blackId, long whiteTime, long blackTime, int wRating, int bRating)
    {
        // Global Navigation Logic
        // Navigate to PlayOnline with Game params
        var url = $"/play-online?id={gameId}&fen={Uri.EscapeDataString(fen)}&white={whiteId}&black={blackId}";
        
        // Check if we are already there to avoid reload if not needed, but Nav.NavigateTo handles it.
        // If we are currently on PlayOnline, navigation might just update params.
        Nav.NavigateTo(url);
        
        // Clear challenges
        activeChallenges.Clear();
        InvokeAsync(StateHasChanged);
    }
}
