@page "/settings"
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))
@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Components
@using Chess960.Web.Client.Models
@using Microsoft.AspNetCore.Components.Authorization
@using System.Net.Http.Headers
@inject IJSRuntime JSRuntime
@inject PieceThemeService PieceThemeService
@inject HttpClient Http
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<div class="max-w-4xl mx-auto animate-soft-up">
    <div class="glass-panel p-8 mb-8">
        <h1 class="text-4xl font-display font-bold text-white mb-2">Settings</h1>
        <p class="text-theme-muted text-lg">Customize your Chess960 experience.</p>
    </div>

    <!-- Tabs -->
    <div class="flex gap-4 mb-8 overflow-x-auto pb-2">
        <button @onclick="@(() => activeTab = "appearance")" 
                class="px-6 py-3 rounded-full font-bold transition-all @(activeTab == "appearance" ? "bg-theme-accent text-black shadow-glow" : "bg-white/5 text-white hover:bg-white/10")">
            <span class="bi bi-palette-fill mr-2"></span> Appearance
        </button>
        <button @onclick="@(() => activeTab = "board")" 
                class="px-6 py-3 rounded-full font-bold transition-all @(activeTab == "board" ? "bg-theme-accent text-black shadow-glow" : "bg-white/5 text-white hover:bg-white/10")">
            <span class="bi bi-grid-3x3-gap-fill mr-2"></span> Board
        </button>
        <button @onclick="@(() => activeTab = "pieces")" 
                class="px-6 py-3 rounded-full font-bold transition-all @(activeTab == "pieces" ? "bg-theme-accent text-black shadow-glow" : "bg-white/5 text-white hover:bg-white/10")">
            <span class="bi bi-suit-spade-fill mr-2"></span> Pieces
        </button>
         <button @onclick="@(() => activeTab = "account")" 
                class="px-6 py-3 rounded-full font-bold transition-all @(activeTab == "account" ? "bg-theme-accent text-black shadow-glow" : "bg-white/5 text-white hover:bg-white/10")">
            <span class="bi bi-person-circle mr-2"></span> Account
        </button>
    </div>

    <div class="glass-panel p-8">
        @if (activeTab == "appearance")
        {
            <h2 class="text-2xl font-display font-bold text-white mb-6 flex items-center gap-3 animate-fade-in">
                <span class="bi bi-palette-fill text-theme-accent"></span> App Theme
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                @foreach (var theme in appThemes)
                {
                    <button @onclick="@(() => SetTheme(theme.Id))" class="group relative p-6 rounded-2xl border border-white/10 bg-black/40 hover:bg-white/5 transition-all duration-300 text-left">
                        <div class="flex items-center justify-between mb-4">
                            <span class="font-bold text-white text-lg">@theme.Name</span>
                            @if (currentTheme == theme.Id)
                            {
                                <span class="bi bi-check-circle-fill text-theme-accent text-xl"></span>
                            }
                        </div>
                        <div class="h-24 rounded-xl bg-gradient-to-br @theme.GradientClasses relative overflow-hidden border border-white/5">
                            <div class="absolute inset-0 bg-[radial-gradient(circle_at_50%_0%,rgba(255,255,255,0.1),transparent)]"></div>
                            <div class="absolute bottom-4 right-4 px-4 py-1 bg-white/20 backdrop-blur-md text-white text-xs font-bold rounded-full">
                                @(currentTheme == theme.Id ? "Active" : "Select")
                            </div>
                        </div>
                    </button>
                }
            </div>
        }
        else if (activeTab == "board")
        {
             <h2 class="text-2xl font-display font-bold text-white mb-6 flex items-center gap-3 animate-fade-in">
                <span class="bi bi-grid-3x3-gap-fill text-theme-accent"></span> Board Theme
            </h2>

            <div class="grid grid-cols-2 md:grid-cols-4 gap-6 animate-fade-in">
                @foreach (var board in boardThemes)
                {
                    <button @onclick="@(() => SetBoardTheme(board.Id))" class="group relative aspect-square rounded-2xl border-2 @(currentBoardTheme == board.Id ? "border-theme-accent" : "border-transparent") overflow-hidden transition-all duration-300 hover:scale-105">
                        <div class="w-full h-full relative" style="background-color: @board.BlackColor">
                            <div class="absolute inset-0 grid grid-cols-2 grid-rows-2">
                                <div style="background-color: @board.WhiteColor"></div>
                                <div style="background-color: @board.BlackColor"></div>
                                <div style="background-color: @board.BlackColor"></div>
                                <div style="background-color: @board.WhiteColor"></div>
                            </div>
                             @if (currentBoardTheme == board.Id)
                            {
                                <div class="absolute inset-0 bg-black/40 flex items-center justify-center">
                                    <span class="bi bi-check-circle-fill text-theme-accent text-4xl shadow-glow"></span>
                                </div>
                            }
                        </div>
                         <div class="absolute bottom-4 left-1/2 -translate-x-1/2 px-3 py-1 bg-black/80 backdrop-blur shadow-lg border border-white/10 rounded-sm text-[10px] font-bold text-white uppercase tracking-widest pointer-events-none whitespace-nowrap">
                            @board.Name
                        </div>
                    </button>
                }
            </div>
        }
        else if (activeTab == "pieces")
        {
             <h2 class="text-2xl font-display font-bold text-white mb-6 flex items-center gap-3 animate-fade-in">
                <span class="bi bi-suit-spade-fill text-theme-accent"></span> Piece Set
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in">
                @foreach (var pieceSet in pieceThemes)
                {
                    <button @onclick="@(() => SetPieceTheme(pieceSet.Id))" class="group relative p-6 rounded-2xl border border-white/10 bg-black/40 hover:bg-white/5 transition-all duration-300 text-left">
                        <div class="flex items-center justify-between mb-4">
                            <span class="font-bold text-white text-lg">@pieceSet.Name</span>
                             @if (currentPieceTheme == pieceSet.Id)
                            {
                                <span class="bi bi-check-circle-fill text-theme-accent text-xl"></span>
                            }
                        </div>

                         <div class="h-32 rounded-xl bg-white/5 relative flex items-center justify-center gap-4 border border-white/5">
                             @* Preview Pieces *@
                             <ChessPiece PieceType="@('N')" IsWhite="true" Theme="@pieceSet.Id" Class="w-16 h-16 pointer-events-none" />
                             <ChessPiece PieceType="@('K')" IsWhite="false" Theme="@pieceSet.Id" Class="w-16 h-16 pointer-events-none" />
                        </div>
                    </button>
                }
            </div>
        }
        else if (activeTab == "account")
        {
            <h2 class="text-2xl font-display font-bold text-white mb-6 flex items-center gap-3 animate-fade-in">
                <span class="bi bi-person-circle text-theme-accent"></span> Account Settings
            </h2>

            <div class="glass-panel p-8 max-w-xl animate-fade-in space-y-8">
                <!-- Avatar Section -->
                <div>
                     <label class="text-xs text-theme-muted font-bold uppercase tracking-wider mb-4 block">Profile Picture</label>
                     <div class="flex items-center gap-6">
                        <div class="relative group w-24 h-24 flex-shrink-0">
                            <div class="w-full h-full rounded-full bg-gradient-to-br from-theme-accent to-theme-glow flex items-center justify-center text-3xl font-bold text-black border-2 border-white/10 overflow-hidden shadow-lg">
                                @if (!string.IsNullOrEmpty(profilePictureUrl))
                                {
                                    <img src="@profilePictureUrl" class="w-full h-full object-cover" />
                                }
                                else if (!string.IsNullOrEmpty(username))
                                {
                                    @username.Substring(0, 1).ToUpper()
                                }
                                else
                                {
                                    <span class="bi bi-person-fill text-white/50"></span>
                                }
                            </div>
                            <label class="absolute inset-0 rounded-full bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center cursor-pointer transition-opacity duration-200">
                                <span class="bi bi-camera-fill text-white text-xl"></span>
                                <InputFile OnChange="UploadAvatar" class="hidden" accept=".jpg,.png,.jpeg,.webp" />
                            </label>
                        </div>
                        <div class="flxe-1">
                             <p class="text-white font-bold mb-1">Change Avatar</p>
                             <p class="text-sm text-theme-muted mb-3">Click the image to upload. Max 2MB.</p>
                        </div>
                     </div>
                </div>

                <div class="border-t border-white/10 pt-8">
                    <label class="text-xs text-theme-muted font-bold uppercase tracking-wider mb-2 block">Username Profile</label>
                <div class="flex gap-2">
                        <input @bind="newUsername" disabled="@cannotChangeName" 
                            class="flex-1 bg-white/5 border border-white/10 rounded-lg px-4 py-3 text-white focus:outline-none focus:border-theme-accent/50 disabled:opacity-50 disabled:cursor-not-allowed transition-colors placeholder-white/20"
                            placeholder="New username" />
                        <button @onclick="SaveUsername" disabled="@cannotChangeName" 
                                class="bg-theme-accent text-black font-bold uppercase text-xs px-4 rounded-lg hover:brightness-110 active:scale-95 transition-all disabled:opacity-50 disabled:scale-100 disabled:cursor-not-allowed shadow-lg">
                            Save
                        </button>
                </div>
                @if (cannotChangeName) {
                    <div class="text-xs text-theme-muted mt-2 flex items-center gap-2 ">
                        <span class="bi bi-clock-history"></span>
                        <span>Next change: <span class="font-mono text-white">@nextChangeDate?.ToString("MMM dd, yyyy")</span></span>
                    </div>
                }
                else 
                {
                    <div class="text-xs text-theme-muted mt-2 flex items-center gap-2">
                        <span class="bi bi-info-circle"></span> You can change your username once every 30 days.
                    </div>
                }

                @if (!string.IsNullOrEmpty(profileMessage))
                {
                    <div class="mt-4 text-sm p-3 rounded-lg border @(isProfileError ? "bg-red-500/10 border-red-500/30 text-red-400" : "bg-green-500/10 border-green-500/30 text-green-400") flex items-center gap-2 animate-fade-in">
                        <span class="bi @(isProfileError ? "bi-exclamation-triangle-fill" : "bi-check-circle-fill")"></span>
                        @profileMessage
                    </div>
                }
            </div>
        </div>
    }
    </div>
</div>

@code {
    private string activeTab = "appearance";
    private string currentTheme = "green";
    private string currentBoardTheme = "default";
    private string currentPieceTheme = "standard";

    // Account State
    private string username = "";
    private string profilePictureUrl = "";
    private string newUsername = "";
    private DateTime? nextChangeDate;
    private bool cannotChangeName => nextChangeDate.HasValue && nextChangeDate.Value > DateTime.UtcNow;
    private string profileMessage = "";
    private bool isProfileError = false;

    // Data Models for Options
    record AppTheme(string Id, string Name, string GradientClasses);
    record BoardTheme(string Id, string Name, string WhiteColor, string BlackColor);
    record PieceTheme(string Id, string Name);
    
    // Response Models
    private class UsernameResponse { public string Username { get; set; } = ""; }
    private class AvatarResponse { public string Url { get; set; } = ""; }


    private List<AppTheme> appThemes = new()
    {
        new("green", "Neon Green", "from-[#050505] to-[#064e3b]"), // to-emerald-900
        new("gold", "Royal Gold", "from-[#080808] to-[#78350f]"),   // to-amber-900
        new("blue", "Electric Blue", "from-[#020617] to-[#1e3a8a]"), // to-blue-900
        new("purple", "Cyber Purple", "from-[#0f0518] to-[#581c87]"), // to-purple-900
    };

    private List<BoardTheme> boardThemes = new()
    {
        new("default", "Green", "#f0fdf4", "#15803d"),
        new("wood", "Wood", "#f0d9b5", "#b58863"),
        new("blue", "Ice", "#ddeeff", "#4b7399"),
        new("ocean", "Ocean", "#f0fdf4", "#1e3a8a"),
        new("grayscale", "Slate", "#e5e5e5", "#525252"),
        new("purple", "Mystery", "#f3e8ff", "#6b21a8"),
    };

    private List<PieceTheme> pieceThemes = new()
    {
        new("standard", "Standard"),
        new("neon", "Neon Glow"),
        new("gold", "Golden"),
        new("glass", "Frosted Glass"),
        new("cburnett", "Classic (Lichess)"),
        new("alpha", "Alpha"),
        new("merida", "Merida"),
        new("leipzig", "Leipzig"),
        new("maestro", "Maestro"),
        new("cardinal", "Cardinal"),
    };

    protected override void OnInitialized()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        if (uri.Query.Contains("tab=account"))
        {
            activeTab = "account";
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            currentTheme = await JSRuntime.InvokeAsync<string>("themeService.getTheme") ?? "green";
            currentBoardTheme = await JSRuntime.InvokeAsync<string>("themeService.getBoardTheme") ?? "default";
            currentPieceTheme = PieceThemeService.CurrentTheme; // Already init by layout usually, or we init here
            
            // Sync if service not init
            if (string.IsNullOrEmpty(currentPieceTheme) || currentPieceTheme == "standard")
            {
                 await PieceThemeService.InitializeAsync();
                 currentPieceTheme = PieceThemeService.CurrentTheme;
            }
             
             // Initial Load of User Data
             await LoadUserData();

            StateHasChanged();
        }
    }
    
    private async Task LoadUserData()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity?.IsAuthenticated ?? false)
        {
            try 
            {
                var userStats = await Http.GetFromJsonAsync<UserDto>("api/user/me");
                if (userStats != null)
                {
                    username = userStats.UserName;
                    newUsername = username;
                    profilePictureUrl = userStats.ProfilePictureUrl;
                    
                    if (userStats.LastUsernameChange.HasValue)
                    {
                        var next = userStats.LastUsernameChange.Value.AddDays(30);
                        if (next > DateTime.UtcNow) nextChangeDate = next;
                    }
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error fetching user stats: {ex.Message}");
            }
        }
    }

    private async Task SaveUsername()
    {
        if (string.IsNullOrWhiteSpace(newUsername)) return;
        
        try
        {
            var response = await Http.PostAsJsonAsync("api/user/username", new { NewUsername = newUsername });
             if (response.IsSuccessStatusCode)
            {
                 var result = await response.Content.ReadFromJsonAsync<UsernameResponse>();
                 if (result != null)
                 {
                     username = result.Username;
                     newUsername = username;
                     profileMessage = "Username changed successfully!";
                     isProfileError = false;
                     nextChangeDate = DateTime.UtcNow.AddDays(30);
                 }
            }
            else
            {
                 var error = await response.Content.ReadAsStringAsync();
                profileMessage = "Error: " + error;
                isProfileError = true;
            }
        }
        catch (Exception ex)
        {
            profileMessage = "Error: " + ex.Message;
            isProfileError = true;
        }
    }

    private async Task UploadAvatar(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null) return;

            // Max 2MB
            var maxFileSize = 2 * 1024 * 1024;
            
            using var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(maxFileSize));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);

            var response = await Http.PostAsync("api/user/avatar", content);
            if (response.IsSuccessStatusCode)
            {
                    var result = await response.Content.ReadFromJsonAsync<AvatarResponse>();
                    if (result != null)
                    {
                        profilePictureUrl = result.Url;
                        profileMessage = "Avatar updated successfully!";
                        isProfileError = false;
                        StateHasChanged();
                    }
            }
            else
            {
                profileMessage = "Upload failed: " + response.ReasonPhrase;
                isProfileError = true;
            }
        }
        catch (Exception ex)
        {
            profileMessage = "Error: " + ex.Message;
            isProfileError = true;
        }
    }

    private async Task SetTheme(string theme)
    {
        currentTheme = theme;
        await JSRuntime.InvokeVoidAsync("themeService.setTheme", theme);
    }

    private async Task SetBoardTheme(string theme)
    {
        currentBoardTheme = theme;
        await JSRuntime.InvokeVoidAsync("themeService.setBoardTheme", theme);
    }
    
    private async Task SetPieceTheme(string theme)
    {
        currentPieceTheme = theme;
        await PieceThemeService.SetThemeAsync(theme);
    }
}
