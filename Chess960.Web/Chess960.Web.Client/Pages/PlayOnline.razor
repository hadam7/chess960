@page "/play-online"
@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Components
@inject MultiplayerService Multiplayer
@inject ChessGameService GameService
@inject NavigationManager Nav
@implements IAsyncDisposable
@rendermode InteractiveWebAssembly

<PageTitle>Play Chess960 Online</PageTitle>

<div class="h-[calc(100vh-4rem)] flex flex-col md:flex-row overflow-hidden animate-soft-up">
    
    <!-- LEFT: Game Board Area -->
    <div class="flex-1 relative flex justify-center items-center p-4">
        <!-- Board Container with Glow -->
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-theme-accent to-theme-glow opacity-20 blur-xl group-hover:opacity-40 transition duration-1000"></div>
            <div class="relative w-full max-w-[85vh] aspect-square shadow-2xl rounded-lg overflow-hidden border-4 border-white/5 bg-black/50 backdrop-blur-sm">
                <ChessBoard IsWhiteSide="@amIWhite" OnMove="HandleLocalMove" />
            </div>
        </div>

        <!-- Player Info Overlays (Only visible when game is active) -->
        @if (!string.IsNullOrEmpty(GameId))
        {
            <div class="absolute top-4 left-4 flex items-center gap-3 bg-black/60 backdrop-blur-md p-2 rounded-lg text-white font-bold border border-white/10 shadow-lg">
                <div class="w-10 h-10 rounded bg-white/10 flex items-center justify-center border border-white/10">
                    <span class="bi bi-person-fill text-xl"></span>
                </div>
                <div class="flex flex-col leading-tight">
                    <span class="text-xs text-theme-muted uppercase tracking-wider">Opponent</span>
                    <span>Unknown</span>
                </div>
            </div>

            <div class="absolute bottom-4 left-4 flex items-center gap-3 bg-black/60 backdrop-blur-md p-2 rounded-lg text-white font-bold border border-white/10 shadow-lg">
                <div class="w-10 h-10 rounded bg-theme-accent text-black flex items-center justify-center shadow-[0_0_15px_rgba(var(--color-accent),0.3)]">
                    <span class="bi bi-person-fill text-xl"></span>
                </div>
                <div class="flex flex-col leading-tight">
                    <span class="text-xs text-theme-muted uppercase tracking-wider">You</span>
                    <span>Me</span>
                </div>
            </div>
        }
    </div>

    <!-- RIGHT: Sidebar Controls -->
    <div class="w-full md:w-[450px] glass-panel border-l border-white/5 relative z-20 flex flex-col">
        
        <!-- Sidebar Tabs -->
        <div class="flex border-b border-white/5 bg-black/20">
            <button class="@GetTabClass("new-game")" @onclick="@(() => activeTab = "new-game")">
                <span class="bi bi-plus-square-fill text-xl mb-1"></span>
                <span class="text-xs font-bold uppercase tracking-wide">Új játszma</span>
            </button>
            <button class="@GetTabClass("games")" @onclick="@(() => activeTab = "games")">
                <span class="bi bi-grid-3x3-gap-fill text-xl mb-1"></span>
                <span class="text-xs font-bold uppercase tracking-wide">Játszmák</span>
            </button>
            <button class="@GetTabClass("players")" @onclick="@(() => activeTab = "players")">
                <span class="bi bi-people-fill text-xl mb-1"></span>
                <span class="text-xs font-bold uppercase tracking-wide">Játékosok</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto p-8 flex flex-col items-center text-center">
            
            @if (activeTab == "new-game")
            {
                <h2 class="text-3xl font-display font-bold text-white mb-2 mt-4">Play Chess<span class="text-theme-accent">960</span></h2>
                <p class="text-theme-muted mb-8 text-sm">Challenge players worldwide in the Fischer Random variation.</p>

                <!-- Time Control Selector -->
                <div class="w-full mb-8">
                    <button class="w-full btn-glass flex items-center justify-between group">
                        <div class="flex items-center gap-3">
                            <span class="bi bi-lightning-fill text-theme-accent group-hover:scale-110 transition-transform"></span>
                            <span class="font-bold">3 perc</span>
                        </div>
                        <span class="bi bi-chevron-down text-white/50"></span>
                    </button>
                    <div class="text-xs text-theme-muted mt-2 text-right opacity-70">Rapid • Nem jegyzett</div>
                </div>

                <!-- Main Action Button -->
                @if (isSearching)
                {
                    <div class="w-full py-8 bg-white/5 rounded-xl flex flex-col items-center justify-center animate-pulse mb-6 border border-white/10">
                        <div class="w-12 h-12 border-4 border-theme-accent border-t-transparent rounded-full animate-spin mb-4"></div>
                        <div class="text-theme-accent font-bold text-lg mb-2 tracking-widest uppercase">Keresés...</div>
                        <button @onclick="CancelSearch" class="text-white/40 hover:text-white text-xs uppercase tracking-widest font-bold mt-2 hover:underline">Mégse</button>
                    </div>
                }
                else if (string.IsNullOrEmpty(GameId))
                {
                    <button @onclick="FindMatch" class="w-full btn-pill text-xl py-5 shadow-[0_0_30px_rgba(var(--color-accent),0.3)] hover:shadow-[0_0_50px_rgba(var(--color-accent),0.5)] mb-6 flex items-center justify-center gap-3 group">
                        <span>Játék indítása</span>
                        <span class="bi bi-play-fill text-3xl group-hover:translate-x-1 transition-transform"></span>
                    </button>
                }
                else
                {
                   <div class="w-full py-8 bg-green-500/10 border border-green-500/20 rounded-xl flex flex-col items-center justify-center mb-4">
                        <div class="text-green-400 font-bold text-lg mb-1">JÁTÉK FOLYAMATBAN</div>
                        <div class="text-white/60 text-sm">Sok sikert!</div>
                    </div> 
                }

                <!-- Secondary Actions -->
                <div class="w-full space-y-3">
                    <button class="w-full btn-glass p-4 rounded-xl flex items-center gap-4 text-left group">
                        <span class="bi bi-gear-fill text-white/30 text-xl group-hover:text-white transition-colors"></span>
                        <span class="font-medium text-white/80 group-hover:text-white">Egyéni kihívás</span>
                    </button>
                    <button class="w-full btn-glass p-4 rounded-xl flex items-center gap-4 text-left group">
                        <span class="bi bi-person-plus-fill text-white/30 text-xl group-hover:text-white transition-colors"></span>
                        <span class="font-medium text-white/80 group-hover:text-white">Ismerős kihívás</span>
                    </button>
                    <button class="w-full btn-glass p-4 rounded-xl flex items-center gap-4 text-left group">
                        <span class="bi bi-trophy-fill text-amber-500/70 text-xl group-hover:text-amber-400 transition-colors"></span>
                        <span class="font-medium text-white/80 group-hover:text-white">Versenyek</span>
                    </button>
                </div>
            }
            else if (activeTab == "games")
            {
                 <div class="text-theme-muted py-10 flex flex-col items-center gap-4">
                     <span class="bi bi-grid-3x3-gap text-4xl opacity-20"></span>
                     <span>Nincsenek aktív játszmák.</span>
                 </div>
            }
            else if (activeTab == "players")
            {
                <div class="text-theme-muted py-10 flex flex-col items-center gap-4">
                     <span class="bi bi-people text-4xl opacity-20"></span>
                     <span>Játékoslista hamarosan...</span>
                </div>
            }

        </div>

        <!-- Footer Stats -->
        <div class="p-6 flex justify-between text-xs font-bold text-theme-muted border-t border-white/5 bg-black/20">
            <div class="flex items-center gap-2">
                <span class="bi bi-activity text-theme-accent"></span>
                <span>157 585 JÁTÉKOS</span>
            </div>
            <div>20 635 103 MAI JÁTSZMA</div>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromQuery(Name = "id")]
    public string? GameId { get; set; }

    [SupplyParameterFromQuery]
    public string? Fen { get; set; }

    [SupplyParameterFromQuery]
    public string? White { get; set; }

    [SupplyParameterFromQuery]
    public string? Black { get; set; }

    private bool amIWhite = true;
    private string? myConnectionId;
    private bool isSearching = false;
    private string activeTab = "new-game";

    protected override async Task OnInitializedAsync()
    {
        await Multiplayer.InitializeAsync();
        myConnectionId = Multiplayer.MyConnectionId;
        
        Multiplayer.OnWaitingForMatch += HandleWaiting;
        Multiplayer.OnGameStarted += HandleGameStarted;
        Multiplayer.OnMoveMade += HandleRemoteMove;

        CheckGameStatus();
    }

    private void CheckGameStatus()
    {
        if (!string.IsNullOrEmpty(GameId))
        {
            // Determine side
            if (myConnectionId == White) amIWhite = true;
            else if (myConnectionId == Black) amIWhite = false;
            
            // Initialize game board
            if (!string.IsNullOrEmpty(Fen))
            {
                GameService.StartGameFromFen(Fen);
            }
        }
    }

    private async Task FindMatch()
    {
        if (isSearching) return;
        isSearching = true;
        await Multiplayer.FindMatch();
    }

    private void CancelSearch()
    {
        isSearching = false;
        // Ideally send cancel to backend
    }

    private void HandleWaiting()
    {
        isSearching = true;
        StateHasChanged();
    }

    private void HandleGameStarted(string gameId, string fen, string whiteId, string blackId)
    {
        isSearching = false;
        GameId = gameId;
        Fen = fen;
        White = whiteId;
        Black = blackId;
        
        // Update URL without reload
        Nav.NavigateTo($"/play-online?id={gameId}&fen={Uri.EscapeDataString(fen)}&white={whiteId}&black={blackId}", false);

        CheckGameStatus();
        StateHasChanged();
    }

    private async Task HandleLocalMove((string from, string to) move)
    {
        if (!string.IsNullOrEmpty(GameId))
        {
             await Multiplayer.MakeMove(GameId, move.from + move.to);
        }
    }

    private void HandleRemoteMove(string moveString, string fen)
    {
        var from = moveString.Substring(0, 2);
        var to = moveString.Substring(2, 2);
        GameService.MakeMove(from, to);
        StateHasChanged();
    }

    private string GetTabClass(string tabName)
    {
        var baseClass = "flex-1 py-4 flex flex-col items-center justify-center transition-colors border-b-2 outline-none";
        if (activeTab == tabName)
        {
            return $"{baseClass} text-theme-accent border-theme-accent bg-white/5"; // Active
        }
        return $"{baseClass} text-theme-muted hover:text-white hover:bg-white/5 border-transparent";
    }

    public async ValueTask DisposeAsync()
    {
        Multiplayer.OnWaitingForMatch -= HandleWaiting;
        Multiplayer.OnGameStarted -= HandleGameStarted;
        Multiplayer.OnMoveMade -= HandleRemoteMove;
    }
}
