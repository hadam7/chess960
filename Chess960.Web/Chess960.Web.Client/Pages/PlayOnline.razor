@page "/play-online"
@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Components
@using Microsoft.AspNetCore.Components.Authorization
@inject MultiplayerService Multiplayer
@inject ChessGameService GameService
@inject HttpClient Http
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@implements IAsyncDisposable
@using System.Threading
@rendermode InteractiveWebAssembly

<PageTitle>Play Chess960 Online</PageTitle>

<div class="h-[calc(100vh-4rem)] flex flex-col md:flex-row overflow-hidden animate-soft-up">
    
    <!-- LEFT: Game Area (Bars + Board) -->
    <div class="flex-1 flex flex-col items-center justify-center p-1 gap-1">
        
        <!-- Opponent Bar -->
        @if (!string.IsNullOrEmpty(GameId))
        {
            <div class="w-full max-w-[calc(100vh-13rem)] flex items-center justify-between bg-black/40 backdrop-blur-md rounded-xl p-2 text-white shadow-2xl border-2 @(IsOpponentTurn ? "border-theme-accent/50 shadow-[0_0_20px_rgba(var(--color-accent),0.2)]" : "border-white/5") transition-all duration-500">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    <div class="w-9 h-9 rounded-lg bg-white/5 flex items-center justify-center border border-white/10 shadow-inner relative overflow-hidden group flex-shrink-0">
                        <div class="absolute inset-0 bg-gradient-to-br from-white/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="bi bi-person-fill text-xl text-white/40 relative z-10"></span>
                    </div>
                    <div class="flex flex-col min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm tracking-tight text-white/90 truncate mr-1" title="@OpponentName">@OpponentName</span>
                            @if (IsOpponentTurn && !isGameFinished)
                            {
                                <div class="w-1.5 h-1.5 bg-theme-accent rounded-full animate-pulse shadow-[0_0_8px_rgba(var(--color-accent),0.8)] flex-shrink-0"></div>
                            }
                        </div>
                        <div class="flex items-center gap-2 leading-none">
                            <span class="text-[9px] font-black uppercase tracking-widest text-theme-muted/60">Rating</span>
                            <span class="text-[10px] text-theme-accent font-mono font-bold">@(amIWhite ? BlackRating : WhiteRating)</span>
                            @if (isGameFinished)
                            {
                                var delta = amIWhite ? blackRatingDelta : whiteRatingDelta;
                                if (delta.HasValue)
                                {
                                    <span class="text-[10px] @(delta >= 0 ? "text-green-400" : "text-red-400") font-bold ml-1">
                                        @(delta >= 0 ? "+" : "")@delta
                                    </span>
                                }
                            }
                        </div>
                    </div>
                </div>
                <!-- Clock -->
                <div class="flex items-center gap-2 ml-4">
                    <div class="h-8 w-[1px] bg-white/5 rounded-full"></div>
                    <ChessClock TimeMs="@OpponentTimeMs" 
                                IsRunning="@(IsOpponentTurn && !isGameFinished)"
                                Class="@(IsOpponentTurn && !isGameFinished ? "bg-theme-accent text-black px-3 py-1 rounded-lg font-mono text-lg font-bold tracking-widest shadow-[0_0_15px_rgba(var(--color-accent),0.4)] border border-theme-accent/50 min-w-[4.5rem] text-center" : "bg-black/40 px-3 py-1 rounded-lg font-mono text-lg font-bold tracking-widest border border-white/5 min-w-[4.5rem] text-center text-white/20")" />
                </div>
            </div>
        }

        <!-- Board -->
        <div class="w-full max-w-[calc(100vh-13rem)] relative aspect-square shadow-2xl rounded-none overflow-hidden border-2 border-white/10 bg-black/50 ring-1 ring-white/5 transition-all duration-500 ease-in-out">
             <ChessBoard IsWhiteSide="@amIWhite" OnMove="HandleLocalMove" OverlayFen="@(IsViewingHistory ? fenHistory[currentViewIndex] : null)" Disabled="@isGameFinished" />
             
             <!-- Game Over Modal (Board Centered) -->
             @if (ShowGameOverModal)
             {
                 <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/60 animate-in fade-in duration-500">
                    
                    @if (IsVictory)
                    {
                        <!-- Confetti Container -->
                        <div class="absolute inset-0 overflow-hidden pointer-events-none">
                            <div class="confetti-container">
                                @for (int i = 0; i < 50; i++)
                                {
                                    <div class="confetti" style="--left: @(Random.Shared.Next(0, 100))%; --dur: @(Random.Shared.NextDouble() * 3 + 2)s; --delay: @(Random.Shared.NextDouble() * 2)s; --color: hsl(@(Random.Shared.Next(0, 360)), 100%, 50%);"></div>
                                }
                            </div>
                        </div>
                    }
        
                    <div class="relative bg-[#1a1a1a] w-3/4 max-w-sm rounded-2xl shadow-[0_0_50px_rgba(0,0,0,0.8)] border border-white/10 overflow-hidden transform scale-100 animate-in zoom-in-95 duration-300 flex flex-col items-center text-center p-6">
                        
                        <!-- Close Button -->
                        <button @onclick="CloseGameOver" class="absolute top-3 right-3 text-white/30 hover:text-white transition-colors">
                            <span class="bi bi-x-lg text-lg"></span>
                        </button>
        
                        <!-- Icon/status -->
                        <div class="mb-4 relative">
                            <div class="absolute inset-0 @(IsVictory ? "bg-green-500" : (IsDraw || IsAborted ? "bg-gray-500" : "bg-red-500")) blur-xl opacity-20 rounded-full"></div>
                            <span class="bi @(IsVictory ? "bi-trophy-fill text-green-400" : (IsDraw ? "bi-dash-circle-fill text-gray-400" : (IsAborted ? "bi-slash-circle-fill text-gray-400" : "bi-x-circle-fill text-red-500"))) text-5xl relative z-10 drop-shadow-lg"></span>
                        </div>
        
                        <!-- Text -->
                        <h2 class="text-4xl font-black italic tracking-tighter mb-1 text-white uppercase drop-shadow-md">
                            @GameOverMessage
                        </h2>
                        
                        <div class="h-1 w-12 @(IsVictory ? "bg-green-500" : (IsDraw || IsAborted ? "bg-gray-500" : "bg-red-500")) rounded-full mb-4"></div>
        
                        <p class="text-white/50 font-bold text-[10px] uppercase tracking-[0.3em] mb-6">
                            @GameOverSubtext
                        </p>

                        <!-- Rating Change -->
                        @if (NewRating.HasValue && RatingChange.HasValue)
                        {
                            <div class="mb-8 flex flex-col items-center animate-in slide-in-from-bottom-2 delay-100 duration-700">
                                <div class="text-5xl font-extrabold text-white tracking-widest drop-shadow-lg mb-1">
                                    @NewRating
                                </div>
                                <div class="text-[11px] font-black uppercase tracking-[0.2em] flex items-center gap-2 @(RatingChange >= 0 ? "text-green-400" : "text-red-400")">
                                    <span class="opacity-50">Rating</span>
                                    <span>@(RatingChange >= 0 ? "+" : "")@RatingChange</span>
                                    <span class="bi @(RatingChange >= 0 ? "bi-graph-up-arrow" : "bi-graph-down-arrow")"></span>
                                </div>
                            </div>
                        }
        
                        <!-- Buttons -->
                        <div class="w-full space-y-2">
                            <button @onclick="StartNewGameSearch" class="w-full py-3 bg-white text-black font-black text-sm uppercase tracking-wider rounded-lg hover:scale-105 transition-transform shadow-lg active:scale-95">
                                <span class="bi bi-controller mr-2"></span> Új Játék
                            </button>
                            
                            <button @onclick="CloseGameOver" class="w-full py-2 bg-white/5 text-white/70 font-bold uppercase text-[10px] tracking-widest rounded-lg hover:bg-white/10 hover:text-white transition-colors">
                                Elemzés
                            </button>
                        </div>
                    </div>
                </div>
             }
        </div>

        <!-- Player Bar -->
        @if (!string.IsNullOrEmpty(GameId))
        {
            <div class="w-full max-w-[calc(100vh-13rem)] flex items-center justify-between bg-black/40 backdrop-blur-md rounded-xl p-2 text-white shadow-2xl border-2 @(IsMyTurn ? "border-theme-accent/50 shadow-[0_0_20px_rgba(var(--color-accent),0.2)]" : "border-white/5") transition-all duration-500">
                <div class="flex items-center gap-3 min-w-0 flex-1">
                    <div class="w-9 h-9 rounded-lg bg-theme-accent flex items-center justify-center shadow-[0_0_15px_rgba(var(--color-accent),0.3)] relative overflow-hidden group flex-shrink-0">
                        <div class="absolute inset-0 bg-white/20 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <span class="bi bi-person-fill text-xl text-black relative z-10"></span>
                    </div>
                    <div class="flex flex-col min-w-0 flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm tracking-tight text-white/90 truncate mr-1" title="@CurrentUserName">@CurrentUserName</span>
                            @if (IsMyTurn && !isGameFinished)
                            {
                                <div class="w-1.5 h-1.5 bg-theme-accent rounded-full animate-pulse shadow-[0_0_8px_rgba(var(--color-accent),0.8)] flex-shrink-0"></div>
                            }
                        </div>
                        <div class="flex items-center gap-2 leading-none">
                            <span class="text-[9px] font-black uppercase tracking-widest text-theme-muted/60">Rating</span>
                            <span class="text-[10px] text-theme-accent font-mono font-bold">@(amIWhite ? WhiteRating : BlackRating)</span>
                            @if (isGameFinished)
                            {
                                var delta = amIWhite ? whiteRatingDelta : blackRatingDelta;
                                if (delta.HasValue)
                                {
                                    <span class="text-[10px] @(delta >= 0 ? "text-green-400" : "text-red-400") font-bold ml-1">
                                        @(delta >= 0 ? "+" : "")@delta
                                    </span>
                                }
                            }
                        </div>
                    </div>
                </div>
                <!-- Clock -->
                <div class="flex items-center gap-2 ml-4">
                    <div class="h-8 w-[1px] bg-white/5 rounded-full"></div>
                    <ChessClock TimeMs="@MyTimeMs" 
                                IsRunning="@(IsMyTurn && !isGameFinished)"
                                Class="@(IsMyTurn && !isGameFinished ? "bg-white text-black px-3 py-1 rounded-lg font-mono text-lg font-bold tracking-widest shadow-[0_0_20px_rgba(255,255,255,0.3)] border border-white/50 min-w-[4.5rem] text-center" : "bg-black/40 px-3 py-1 rounded-lg font-mono text-lg font-bold tracking-widest border border-white/5 min-w-[4.5rem] text-center text-white/20")" />
                </div>
            </div>
        }
    </div>

    <!-- RIGHT: Sidebar Controls -->
    <div class="w-full md:w-[400px] bg-black/20 backdrop-blur-xl border-l border-white/5 relative z-20 flex flex-col">
        
        <!-- Sidebar Tabs -->
         <div class="flex bg-black/20 border-b border-white/5">
            @if (!string.IsNullOrEmpty(GameId))
            {
                <button class="@GetTabClass("game")" @onclick="@(() => activeTab = "game")">
                    <span class="bi bi-lightning-fill text-lg mb-1"></span>
                    <span class="text-xs font-bold uppercase tracking-wide">Játék</span>
                </button>
            }
            <button class="@GetTabClass("new-game")" @onclick="@(() => activeTab = "new-game")">
                <span class="bi bi-plus-square-fill text-lg mb-1"></span>
                <span class="text-xs font-bold uppercase tracking-wide">Új játszma</span>
            </button>
            <button class="@GetTabClass("games")" @onclick="@(() => activeTab = "games")">
                <span class="bi bi-grid-3x3-gap-fill text-lg mb-1"></span>
                <span class="text-xs font-bold uppercase tracking-wide">Játszmák</span>
            </button>
        </div>

        <!-- Tab Content -->
        <div class="flex-1 overflow-y-auto flex flex-col relative">
            
            @if (activeTab == "game" && !string.IsNullOrEmpty(GameId))
            {
                <!-- Move List -->
                <div class="flex-1 overflow-y-auto p-0 scrollbar-thin scrollbar-thumb-white/10 scrollbar-track-transparent">
                     <table class="w-full text-sm text-left">
                         <thead class="bg-white/5 text-xs uppercase text-theme-muted sticky top-0 backdrop-blur-md">
                             <tr>
                                 <th class="px-4 py-2 w-10">#</th>
                                 <th class="px-4 py-2">White</th>
                                 <th class="px-4 py-2">Black</th>
                             </tr>
                         </thead>
                         <tbody>
                             @for (int i = 0; i < moveList.Count; i += 2)
                             {
                                 var moveNum = (i / 2) + 1;
                                 var whiteMove = moveList[i];
                                 var blackMove = (i + 1 < moveList.Count) ? moveList[i + 1] : "";
                                 
                                 <tr class="border-b border-white/5 hover:bg-white/5 transition-colors @(i/2 % 2 == 0 ? "bg-white/[0.02]" : "")">
                                     <td class="px-4 py-2 text-theme-muted font-mono text-xs">@moveNum.</td>
                                     <td class="px-4 py-2 font-bold cursor-pointer hover:text-theme-accent">@whiteMove</td>
                                     <td class="px-4 py-2 font-bold cursor-pointer hover:text-theme-accent">@blackMove</td>
                                 </tr>
                             }
                         </tbody>
                     </table>
                     
                    @if (moveList.Count == 0)
                    {
                        <div class="flex flex-col items-center justify-center h-40 text-theme-muted opacity-50">
                            <span class="bi bi-hourglass-split text-3xl mb-2"></span>
                            <span>Game started</span>
                        </div>
                    }
                </div>

                <!-- Game Controls -->
                <div class="p-4 bg-black/20 border-t border-white/5 relative">
                    
                    <!-- Draw Offer Toast (Embedded in Sidebar) -->
                    @if (ShowDrawOffer)
                    {
                        <div class="absolute bottom-full left-0 w-full bg-[#1a1a1a] border-t border-white/10 shadow-[0_-10px_40px_rgba(0,0,0,0.5)] p-4 flex items-center justify-between gap-4 animate-in slide-in-from-bottom-4 fade-in duration-300 z-30">
                            <div class="flex flex-col">
                                <span class="font-bold text-white uppercase tracking-wider text-xs">Döntetlen?</span>
                                <span class="text-[9px] text-white/50 uppercase tracking-widest">Az ellenfél ajánlata</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button @onclick="AcceptDraw" class="w-8 h-8 flex items-center justify-center bg-green-500/20 text-green-400 rounded-lg hover:bg-green-500 hover:text-black transition-all" title="Elfogad">
                                    <span class="bi bi-check-lg text-lg"></span>
                                </button>
                                <button @onclick="DeclineDraw" class="w-8 h-8 flex items-center justify-center bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500 hover:text-black transition-all" title="Elutasít">
                                    <span class="bi bi-x-lg text-lg"></span>
                                </button>
                            </div>
                        </div>
                    }
                    <!-- Navigation (Step Buttons) -->
                    <div class="flex items-center justify-center gap-2 mb-4">
                        <button @onclick="StepFirst" disabled="@(fenHistory.Count == 0 || currentViewIndex <= 0)" class="w-8 h-8 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><span class="bi bi-skip-backward-fill"></span></button>
                        <button @onclick="StepPrev" disabled="@(fenHistory.Count == 0 || currentViewIndex <= 0)" class="w-8 h-8 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><span class="bi bi-caret-left-fill"></span></button>
                        <button @onclick="StepNext" disabled="@(fenHistory.Count == 0 || currentViewIndex >= fenHistory.Count - 1)" class="w-8 h-8 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><span class="bi bi-caret-right-fill"></span></button>
                        <button @onclick="StepLast" disabled="@(fenHistory.Count == 0 || currentViewIndex >= fenHistory.Count - 1)" class="w-8 h-8 flex items-center justify-center rounded bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors disabled:opacity-30 disabled:cursor-not-allowed"><span class="bi bi-skip-forward-fill"></span></button>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                         <button @onclick="ResignGame" class="bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors rounded text-xs py-2 flex items-center justify-center gap-2">
                             @if (CanAbort)
                             {
                                 <span class="bi bi-x-circle-fill text-red-400"></span> <span>Mégsem</span>
                             }
                             else
                             {
                                 <span class="bi bi-flag-fill"></span> <span>Feladás</span>
                             }
                         </button>
                          <button @onclick="OfferDraw" class="bg-white/5 hover:bg-white/10 text-theme-muted hover:text-white transition-colors rounded text-xs py-2 flex items-center justify-center gap-2">
                             <span class="bi bi-circle-half"></span> Döntetlen
                         </button>
                    </div>
                </div>
            }
            else if (activeTab == "new-game")
            {
                <div class="p-8 text-center">
                    <h2 class="text-3xl font-display font-bold text-white mb-2 mt-4">Play Chess<span class="text-theme-accent">960</span></h2>
                    <!-- ... (Existing New Game Content) ... -->
                    <div class="w-full mb-8 space-y-4">
                        <!-- ... (We keep the content but abbreviated here for brevity if it was large, but I will include it) ... -->
                         <!-- Section: Rapid -->
                        <div class="text-left">
                            <div class="text-xs text-theme-muted font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <span class="bi bi-stopwatch-fill"></span> Normál (Rapid)
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @onclick="@(() => selectedTimeControl = "10+0")" class="@GetTimeClass("10+0")">10 p</button>
                                <button @onclick="@(() => selectedTimeControl = "15+10")" class="@GetTimeClass("15+10")">15|10</button>
                                <button @onclick="@(() => selectedTimeControl = "30+0")" class="@GetTimeClass("30+0")">30 p</button>
                            </div>
                        </div>
                        <!-- Section: Blitz -->
                        <div class="text-left">
                            <div class="text-xs text-theme-muted font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <span class="bi bi-lightning-fill"></span> Villám (Blitz)
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @onclick="@(() => selectedTimeControl = "3+0")" class="@GetTimeClass("3+0")">3 p</button>
                                <button @onclick="@(() => selectedTimeControl = "3+2")" class="@GetTimeClass("3+2")">3|2</button>
                                <button @onclick="@(() => selectedTimeControl = "5+0")" class="@GetTimeClass("5+0")">5 p</button>
                            </div>
                        </div>
                         <!-- Section: Bullet -->
                        <div class="text-left">
                            <div class="text-xs text-theme-muted font-bold uppercase tracking-wider mb-2 flex items-center gap-2">
                                    <span class="bi bi-rocket-takeoff-fill"></span> Bullet
                            </div>
                            <div class="grid grid-cols-3 gap-2">
                                <button @onclick="@(() => selectedTimeControl = "1+0")" class="@GetTimeClass("1+0")">1 p</button>
                                <button @onclick="@(() => selectedTimeControl = "1+1")" class="@GetTimeClass("1+1")">1|1</button>
                                <button @onclick="@(() => selectedTimeControl = "2+1")" class="@GetTimeClass("2+1")">2|1</button>
                            </div>
                        </div>
                    </div>

                    @if (isSearching)
                    {
                         <div class="w-full py-8 bg-white/5 rounded-xl flex flex-col items-center justify-center animate-pulse mb-6 border border-white/10">
                            <div class="w-12 h-12 border-4 border-theme-accent border-t-transparent rounded-full animate-spin mb-4"></div>
                            <div class="text-theme-accent font-bold text-lg mb-2 tracking-widest uppercase">Keresés...</div>
                            <button @onclick="CancelSearch" class="text-white/40 hover:text-white text-xs uppercase tracking-widest font-bold mt-2 hover:underline">Mégse</button>
                        </div>
                    }
                    else if (string.IsNullOrEmpty(GameId))
                    {
                          <button @onclick="FindMatch" class="w-full btn-pill text-xl py-5 shadow-[0_0_30px_rgba(var(--color-accent),0.3)] hover:shadow-[0_0_50px_rgba(var(--color-accent),0.5)] mb-6 flex items-center justify-center gap-3 group">
                            <span>Játék</span>
                            <span class="bi bi-play-fill text-3xl group-hover:translate-x-1 transition-transform"></span>
                        </button>
                    }
                    else 
                    {
                        <div class="text-green-400 font-bold mb-4">Játék Folyamatban!</div>
                    }
                </div>
            }
            else if (activeTab == "games")
            {
                 <div class="text-theme-muted py-10 flex flex-col items-center gap-4">
                     <span class="bi bi-grid-3x3-gap text-4xl opacity-20"></span>
                     <span>Nincsenek aktív játszmák.</span>
                 </div>
            }
        </div>
        
        <!-- Challenge Received Modal -->
        @if (incomingChallenge != null)
        {
            <div class="absolute inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200">
                <div class="bg-[#1a1a1a] w-full max-w-xs rounded-xl shadow-2xl border border-theme-accent/30 p-6 text-center">
                    <div class="w-16 h-16 rounded-full bg-theme-accent/20 flex items-center justify-center mx-auto mb-4 animate-pulse">
                        <span class="bi bi-lightning-charge-fill text-3xl text-theme-accent"></span>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1">Kihívás!</h3>
                    <p class="text-theme-muted text-sm mb-6">
                        <span class="text-white font-bold">@incomingChallenge.RequesterName</span> kihívott egy 
                        <span class="text-theme-accent font-mono">@incomingChallenge.TimeControl</span> meccsre.
                    </p>
                    
                    <div class="flex gap-3">
                         <button @onclick="AcceptChallenge" class="flex-1 py-3 bg-theme-accent text-black font-bold rounded hover:bg-theme-accent/90 transition-colors uppercase tracking-wider text-xs">
                             Elfogad
                         </button>
                         <button @onclick="DeclineChallenge" class="flex-1 py-3 bg-white/10 text-white font-bold rounded hover:bg-white/20 transition-colors uppercase tracking-wider text-xs">
                             Elutasít
                         </button>
                    </div>
                </div>
            </div>
        }

        
         <!-- Footer Stats -->
        <div class="p-4 flex justify-between text-[10px] font-bold text-theme-muted border-t border-white/5 bg-black/20">
            <div class="flex items-center gap-2">
                <span class="bi bi-circle-fill text-green-500 text-[6px]"></span>
                <span>@OnlineUsersCount Online</span>
            </div>
            <div>@GamesTodayCount Játszma ma</div>
        </div>

    </div>
</div>

<style>

    /* Custom Scrollbar for sidebar */
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
        background-color: rgba(255,255,255,0.1);
        border-radius: 3px;
    }
</style>





    <style>
        .confetti-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .confetti {
            position: absolute;
            width: 10px; // slightly smaller
            height: 10px;
            background-color: var(--color);
            left: var(--left);
            animation: fall var(--dur) linear infinite; /* Loop it */
            animation-delay: var(--delay);
            opacity: 0;
            top: -10px;
        }
        @@keyframes fall {
            0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }
    </style>

@code {
    [SupplyParameterFromQuery(Name = "id")]
    public string? GameId { get; set; }

    [SupplyParameterFromQuery]
    public string? Fen { get; set; }

    [SupplyParameterFromQuery]
    public string? White { get; set; }

    [SupplyParameterFromQuery]
    public string? Black { get; set; }

    private bool amIWhite = true;
    private bool isSearching = false;
    private string activeTab = "new-game";
    private string selectedTimeControl = "3+2"; 
    private string CurrentUserName = "You";
    private string? OpponentName;
    private int WhiteRating = 1200;
    private int BlackRating = 1200;
    private long MyTimeMs => amIWhite ? WhiteTimeMs : BlackTimeMs; 
    
    // Time State
    private long WhiteTimeMs { get; set; }
    private long BlackTimeMs { get; set; }
    // private Timer? clockTimer; -- Removed in favor of ChessClock component

    // Game End State
    private string? GameOverMessage;
    private string? GameOverSubtext;
    private bool ShowGameOverModal = false;
    private bool IsVictory = false;
    private bool IsDraw = false;
    private bool IsAborted = false;
    private bool isGameFinished = false;
    private int? whiteRatingDelta;
    private int? blackRatingDelta;

    // ...

    public ValueTask DisposeAsync()
    {
        Multiplayer.OnWaitingForMatch -= HandleWaiting;
        Multiplayer.OnGameStarted -= HandleGameStarted;
        Multiplayer.OnMoveMade -= HandleRemoteMove;
        Multiplayer.OnGameOver -= HandleGameOver;
        Multiplayer.OnDrawOffered -= HandleDrawOffered;
        Multiplayer.OnDrawDeclined -= HandleDrawDeclined;
        Multiplayer.OnServerStatsUpdated -= HandleServerStats;
        
        // Unsubscribe Friend Events
        Multiplayer.OnChallengeReceived -= HandleChallengeReceived;
        
        return ValueTask.CompletedTask;
    }
    
    // Friend System State Removed (moved to Friends.razor)
    
    // Challenge State
    private IncomingChallenge? incomingChallenge;
    private record IncomingChallenge(string RequesterId, string RequesterName, string TimeControl);
    private int? NewRating;
    private int? RatingChange;

    // Server Stats
    private int OnlineUsersCount = 0;
    private int GamesTodayCount = 0;

    // Draw Offer State
    private bool ShowDrawOffer = false;

    // History
    private List<string> fenHistory = new();
    private List<string> moveList = new();
    private int currentViewIndex = -1;
    private bool IsViewingHistory => currentViewIndex != -1 && currentViewIndex < fenHistory.Count - 1;

    private long OpponentTimeMs => amIWhite ? BlackTimeMs : WhiteTimeMs;
    private bool IsMyTurn => GameService.Game != null && amIWhite == GameService.Game.Pos.SideToMove.IsWhite;
    private bool IsOpponentTurn => GameService.Game != null && amIWhite != GameService.Game.Pos.SideToMove.IsWhite;
    
    // Abort Logic: Can abort if I haven't made any moves yet (moveList count logic)
    // If I am White: Moves 0
    // If I am Black: Moves 0 or 1
    private bool CanAbort 
    {
        get 
        {
            if (moveList.Count == 0) return true; // Start of game
            if (!amIWhite && moveList.Count == 1) return true; // Black hasn't moved yet
            return false;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Reset state from previous games
        if (string.IsNullOrEmpty(GameId))
        {
            GameService.Reset();
            isGameFinished = false;
            ShowGameOverModal = false;
        }

        // Auth check
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            CurrentUserName = user.Identity.Name ?? "Player";
            
            Console.WriteLine("[PlayOnline] User Claims:");
            foreach(var claim in user.Claims)
            {
                Console.WriteLine($" - {claim.Type}: {claim.Value}");
            }

            // Set Multiplayer ID to User ID (Guid) for consistency
             var userIdClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) 
                            ?? user.FindFirst("sub");
            
            if (userIdClaim != null)
            {
                Multiplayer.UserId = userIdClaim.Value;
                Console.WriteLine($"[PlayOnline] Set Multiplayer.UserId to {Multiplayer.UserId}");
            }
            else
            {
                Console.WriteLine("[PlayOnline] WARNING: User ID claim missing. Attempting to fetch from API...");
                try 
                {
                    var userInfo = await Http.GetFromJsonAsync<UserInfoResponse>("api/user/me");
                    if (userInfo != null && !string.IsNullOrEmpty(userInfo.UserId))
                    {
                        Multiplayer.UserId = userInfo.UserId;
                        Console.WriteLine($"[PlayOnline] Fetched UserID from API: {Multiplayer.UserId}");
                    }
                }
                catch (Exception ex)
                {
                     Console.WriteLine($"[PlayOnline] Failed to fetch user info: {ex.Message}");
                }
            }
        }

        if (!string.IsNullOrEmpty(GameId))
        {
            activeTab = "game";
        }
        else 
        {
            activeTab = "new-game";
        }

        CheckGameStatus();
        // StartClockTimer(); -- Handled by ChessClock
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await Multiplayer.InitializeAsync();
            
            Multiplayer.OnWaitingForMatch += HandleWaiting;
            Multiplayer.OnGameStarted += HandleGameStarted;
            Multiplayer.OnMoveMade += HandleRemoteMove;
            Multiplayer.OnGameOver += HandleGameOver;
            Multiplayer.OnDrawOffered += HandleDrawOffered;
            Multiplayer.OnDrawDeclined += HandleDrawDeclined;
            Multiplayer.OnServerStatsUpdated += HandleServerStats;
            Multiplayer.OnChallengeReceived += HandleChallengeReceived;

            if (!string.IsNullOrEmpty(GameId) && Multiplayer.CurrentGameId != GameId)
            {
               await Multiplayer.JoinGame(GameId);
            }
            
            // Friends loading removed
        }
    }

    private void CheckGameStatus()
    {
        if (!string.IsNullOrEmpty(GameId))
        {
            var myId = Multiplayer.UserId;
            if (myId == White) amIWhite = true;
            else if (myId == Black) amIWhite = false;
            
            if (!string.IsNullOrEmpty(Fen))
            {
                GameService.StartGameFromFen(Fen);
            }
        }
    }

    // private void StartClockTimer() ... Removed

    private async Task FindMatch()
    {
        // Auth guard before searching
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity == null || !authState.User.Identity.IsAuthenticated)
        {
            Nav.NavigateTo("Account/Login");
            return;
        }

        if (isSearching) return;
        isSearching = true;
        await Multiplayer.FindMatch(selectedTimeControl);
    }

    private void CancelSearch()
    {
        isSearching = false;
    }

    private void HandleWaiting()
    {
        isSearching = true;
        StateHasChanged();
    }

    private void HandleServerStats(int onlineUsers, int gamesToday)
    {
        OnlineUsersCount = onlineUsers;
        GamesTodayCount = gamesToday;
        InvokeAsync(StateHasChanged);
    }

    private void HandleGameStarted(string gameId, string fen, string whiteId, string blackId, long whiteTime, long blackTime, int wRating, int bRating)
    {
        // Cancel/Close any search UI
        isSearching = false;
        isSearching = false;
        isGameFinished = false;
        ShowGameOverModal = false;
        IsAborted = false;
        IsVictory = false;
        IsDraw = false;
        
        GameId = gameId; // Set GameId for local use
        
        // Setup Players
        White = whiteId;
        Black = blackId;
        
        // Set Ratings
        WhiteRating = wRating;
        BlackRating = bRating;
        
        // IMPORTANT: Set Multiplayer.UserId if not set (from Auth context logic above)
        // Check game status (Determine colors)
        CheckGameStatus();

        // Start Game
        GameService.StartGameFromFen(fen);
        
        // Sync Time
        WhiteTimeMs = whiteTime;
        BlackTimeMs = blackTime;
        
        // Determine Opponent Name
        if (Multiplayer.UserId == whiteId)
        {
             OpponentName = blackId;
        }
        else
        {
             OpponentName = whiteId;
        }
        
        moveList.Clear(); // New game
        
        // Init history
        fenHistory.Clear();
        fenHistory.Add(fen);
        currentViewIndex = 0;
        
        activeTab = "game";

        Nav.NavigateTo($"/play-online?id={gameId}&fen={Uri.EscapeDataString(fen)}&white={whiteId}&black={blackId}", false);

        CheckGameStatus();
        StateHasChanged();
    }

    private async Task HandleLocalMove((string from, string to) move)
    {
        if (isGameFinished) return;

        Console.WriteLine($"[Client] HandleLocalMove: {move.from} -> {move.to}. GameId: {GameId}");
        if (!string.IsNullOrEmpty(GameId))
        {
             // Add to list optimistically or wait for server?
             // Ideally wait, but for responsiveness...
             // Let's rely on GameService update or just push to server.
             await Multiplayer.MakeMove(GameId, move.from + move.to);
             Console.WriteLine("[Client] Sent move to server.");
             
             // Optimistic update for history? 
             // Better to wait for server confirmation usually, but for responsiveness we might update local board.
             // GameService updates automatically on local move? 
             // Actually Multiplayer.MakeMove calls hub, hub broadcasts move, HandleRemoteMove called for EVERYONE including sender?
             // If so, we handle history in HandleRemoteMove.
             // If not (usually sender doesn't get echo), we need to handle it here.
             // Assuming typical SignalR pattern where sender DOESN'T get echo:
             // But wait, PlayOnline usually relies on echo or local optimistic update.
             // Let's check HandleRemoteMove usage.
             // Looking at GameHub, it sends to Group(gameId) which includes caller?
             // Usually yes unless Clients.OthersInGroup.
             // GameHub.cs: await Clients.Group(gameId).SendAsync("MoveMade"...
             // This includes the caller. So HandleRemoteMove will replace this logic.
        }
    }

    private void HandleRemoteMove(string moveString, string fen, long whiteTime, long blackTime)
    {
        var from = moveString.Substring(0, 2);
        var to = moveString.Substring(2, 2);
        
        // Handle promotion
        if (moveString.Length > 4)
        {
             // If local GameService supports promotion in 'to' string or as 3rd arg.
             // Assuming MakeMove(from, to) handles "e8q" in 'to' or we need to pass it.
             // Looking at ChessBoard.razor, MakeMove(from, to) is used.
             // Let's assume we append it to 'to' if the service expects it that way, 
             // OR usually Rudzoft expects 2 args where 'to' might need to handle it.
             // Safest fix for now to avoid compilation error is:
             // GameService.MakeMove(from, to + promotionChar)
             to += moveString[4];
        }
        
        WhiteTimeMs = whiteTime;
        BlackTimeMs = blackTime;
        

         // Add move to history
         moveList.Add(moveString); 

         // Critical Fix: Sync state perfectly with server
         // Instead of relying on local MakeMove (which might fail or differ), 
         // we force the local board to the server's FEN.
         GameService.StartGameFromFen(fen);
         
         // Update history with new state
         fenHistory.Add(fen);
         
         // If we were at the end, stay at the end
         if (currentViewIndex == fenHistory.Count - 2)
         {
             currentViewIndex = fenHistory.Count - 1;
         }

         StateHasChanged();
    }
    
    // Friend System Methods
    // Friend System Methods Removed (Moved to Friends.razor)
    
    private void HandleChallengeReceived(string requesterId, string requesterName, string timeControl)
    {
        incomingChallenge = new IncomingChallenge(requesterId, requesterName, timeControl);
        StateHasChanged();
    }

    private async Task AcceptChallenge()
    {
        if (incomingChallenge == null) return;
        
        await Multiplayer.RespondToChallengeAsync(incomingChallenge.RequesterId, true, incomingChallenge.TimeControl);
        incomingChallenge = null;
    }

    private void DeclineChallenge()
    {
        // Optional: Notify decline
        incomingChallenge = null;
    }
    
    // Navigation Methods
    private void StepFirst() => currentViewIndex = 0;
    private void StepPrev() => currentViewIndex = Math.Max(0, currentViewIndex - 1);
    private void StepNext() => currentViewIndex = Math.Min(fenHistory.Count - 1, currentViewIndex + 1);
    private void StepLast() => currentViewIndex = fenHistory.Count - 1;

    private string GetTabClass(string tabName)
    {
        var baseClass = "flex-1 py-3 flex flex-col items-center justify-center transition-colors outline-none border-b-2";
        if (activeTab == tabName)
        {
            return $"{baseClass} bg-black/40 text-theme-accent border-theme-accent"; 
        }
        return $"{baseClass} hover:bg-white/5 text-theme-muted hover:text-white border-transparent";
    }
    
    private string GetTimeClass(string timeControl)
    {
         var baseClass = "p-2 rounded border text-xs font-bold transition-all";
         if (selectedTimeControl == timeControl)
         {
             return $"{baseClass} bg-theme-accent text-black border-theme-accent";
         }
         return $"{baseClass} bg-black/40 border-white/10 text-theme-muted hover:bg-white/10 hover:text-white";
    }
    
    // FormatTime removed


    private void HandleGameOver(string winnerId, string reason, string fen, int? wRating, int? bRating, int? wDelta, int? bDelta)
    {
          isGameFinished = true;
          ShowGameOverModal = true;
         
         // Update board one last time to show final position (e.g. mate)
         GameService.StartGameFromFen(fen);

         // Set Rating info
         whiteRatingDelta = wDelta;
         blackRatingDelta = bDelta;

         if (amIWhite)
         {
             NewRating = wRating;
             RatingChange = wDelta;
         }
         else
         {
             NewRating = bRating;
             RatingChange = bDelta;
         }

         if (string.IsNullOrEmpty(winnerId))
         {
             // Draw or Aborted
             IsVictory = false;
             
             if (reason == "Aborted")
             {
                 IsDraw = false; 
                 IsAborted = true;
                 GameOverMessage = "Megszakítva";
                 GameOverSubtext = "A játékot megszakították";
             }
             else 
             {
                 IsDraw = true;
                 IsAborted = false;
                 GameOverMessage = "Döntetlen";
                 GameOverSubtext = ReasonToHungarian(reason);
             }
         }
         else
         {
             IsDraw = false;
             if (winnerId == Multiplayer.UserId)
             {
                 IsVictory = true;
                 GameOverMessage = "Győzelem!";
                 GameOverSubtext = ReasonToHungarian(reason);
             }
             else
             {
                 IsVictory = false;
                 GameOverMessage = "Vereség";
                 GameOverSubtext = ReasonToHungarian(reason);
             }
         }
         InvokeAsync(StateHasChanged);
    }

    private string ReasonToHungarian(string reason)
    {
        return reason switch
        {
            "Checkmate" => "Sakk-matt",
            "Resignation" => "Az ellenfél feladta" + (IsVictory ? "" : " (Te feladtad)"),
            "Timeout" => "Lejárt az idő",
            "Stalemate" => "Patt",
            "DrawAgreed" => "Megegyezés szerint",
            _ => reason
        };
    }

    private void HandleDrawOffered(string senderId)
    {
        if (senderId != Multiplayer.UserId)
        {
            ShowDrawOffer = true;
            InvokeAsync(StateHasChanged);
        }
    }

    private void HandleDrawDeclined()
    {
        // Ideally show a toast, for now just clear our offer state if we had any
        ShowDrawOffer = false;
        InvokeAsync(StateHasChanged);
    }

    private async Task ResignGame()
    {
        if (string.IsNullOrEmpty(GameId)) return;

        if (CanAbort)
        {
             await Multiplayer.AbortAsync(GameId);
        }
        else
        {
             await Multiplayer.ResignAsync(GameId);
        }
    }

    private async Task OfferDraw()
    {
        if (!string.IsNullOrEmpty(GameId))
        {
             await Multiplayer.OfferDrawAsync(GameId);
        }
    }
    
    private async Task AcceptDraw()
    {
        if (!string.IsNullOrEmpty(GameId))
        {
            await Multiplayer.RespondDrawAsync(GameId, true);
            ShowDrawOffer = false;
        }
    }

    private async Task DeclineDraw()
    {
         if (!string.IsNullOrEmpty(GameId))
        {
            await Multiplayer.RespondDrawAsync(GameId, false);
            ShowDrawOffer = false;
        }
    }

    private async Task StartNewGameSearch()
    {
        ShowGameOverModal = false;
        activeTab = "new-game"; // Switch to new game tab to see search UI
        await FindMatch();
    }

    private void CloseGameOver()
    {
        ShowGameOverModal = false;
        // Nav.NavigateTo("/");  -- User wants to stay on the game page
    }


    private class UserInfoResponse
    {
        public string UserId { get; set; } = "";
        public string UserName { get; set; } = "";
    }
}
