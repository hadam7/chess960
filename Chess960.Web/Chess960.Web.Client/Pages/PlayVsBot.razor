@page "/play-bot"
@using Chess960.Web.Client.Services

@using Chess960.Web.Client.Components
@inject ChessGameService GameService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Play vs Bot - Chess960</PageTitle>

<div class="min-h-screen py-4 px-4">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <!-- Left Column: Game Info & Controls -->
        <div class="lg:col-span-1 space-y-6 animate-soft-up">
            <div class="glass-panel p-8">
                <h2 class="text-2xl font-display font-bold mb-6 text-white flex items-center gap-2">
                    <span class="bi bi-sliders text-theme-accent"></span> Configuration
                </h2>
                
                <div class="mb-8">
                    <label class="block text-xs font-bold text-theme-muted mb-4 uppercase tracking-wider">Engine Strength</label>
                    <div class="relative">
                        <input type="range" min="0" max="20" @bind="skillLevel" @bind:event="oninput" 
                               class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-theme-accent">
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <span class="text-xs text-white/50 font-bold">BEGINNER</span>
                        <div class="px-4 py-1 bg-theme-accent/20 text-theme-accent rounded-full font-bold text-sm border border-theme-accent/30 shadow-[0_0_10px_rgba(var(--color-accent),0.2)]">Level @skillLevel</div>
                        <span class="text-xs text-white/50 font-bold">MASTER</span>
                    </div>
                </div>

                <div class="flex gap-4">
                    <button @onclick="StartNewGame" 
                            class="btn-pill w-full text-lg">
                        Start Game
                    </button>
                </div>
            </div>

            <div class="glass-panel p-6">
                <h2 class="text-xl font-display font-bold mb-4 text-white">Status</h2>
                @if (isBotThinking)
                {
                    <div class="flex items-center gap-3 text-white">
                        <div class="relative">
                            <div class="w-3 h-3 bg-theme-accent rounded-full animate-ping absolute opacity-75"></div>
                            <div class="w-3 h-3 bg-theme-accent rounded-full relative"></div>
                        </div>
                        <span class="font-bold text-theme-accent text-glow">Thinking...</span>
                    </div>
                }
                else if (!string.IsNullOrEmpty(GameService.GameOverMessage))
                {
                    <div class="text-white font-bold text-lg p-4 bg-red-500/10 border border-red-500/30 rounded-2xl backdrop-blur-md">
                        @GameService.GameOverMessage
                    </div>
                }
                else
                {
                    <div class="flex items-center gap-3 text-theme-accent">
                        <div class="w-3 h-3 bg-theme-accent rounded-full animate-pulse"></div>
                        <span class="font-bold">Your Turn</span>
                    </div>
                }
            </div>
        </div>

        <!-- Center/Right: Chess Board -->
        <div class="lg:col-span-2 flex justify-center items-start animate-soft-up animate-delay-100">
            <div class="relative">
                <ChessBoard />
                @if (isBotThinking)
                {
                    <!-- Transparent overlay -->
                    <div class="absolute inset-0 z-20 cursor-wait"></div>
                }
            </div>
        </div>
        
        <!-- Debug Console -->
        <div class="lg:col-span-3">
             <div class="glass-panel p-4 bg-black/80 font-mono text-xs text-green-400 h-32 overflow-y-auto">
                <div class="font-bold border-b border-white/20 mb-2">DEBUG CONSOLE</div>
                @foreach(var log in debugLogs)
                {
                    <div>@log</div>
                }
             </div>
        </div>
    </div>
</div>

@code {
    private int skillLevel = 5;
    private bool isBotThinking = false;
    private List<string> debugLogs = new();
    private DotNetObjectReference<PlayVsBot>? dotNetHelper;
    private IJSObjectReference? module;

    private void Log(string message)
    {
        debugLogs.Add($"{DateTime.Now:HH:mm:ss} - {message}");
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                Log("Initializing...");
                dotNetHelper = DotNetObjectReference.Create(this);
                // Load the script as a module
                Log("Importing module...");
                module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/stockfish-interop.js");
                Log("Module imported. Calling init...");
                await module.InvokeVoidAsync("init", dotNetHelper);
                Log("Init success.");
                
                GameService.OnStateChanged += OnGameStateChanged;
                StartNewGame();
            }
            catch (Exception ex)
            {
                Log($"Error during init: {ex.Message}");
            }
        }
    }

    private async void StartNewGame()
    {
        try
        {
            Log("Starting new game...");
            GameService.StartNewGame(true);
            // Reset bot
            if (module != null)
            {
                await module.InvokeVoidAsync("startNewGame", skillLevel);
                Log("Bot reset.");
            }
            isBotThinking = false;
        }
        catch (Exception ex)
        {
            Log($"Error starting game: {ex.Message}");
        }
    }

    private void OnGameStateChanged()
    {
        // Check if it's Black's turn (Bot)
        if (!GameService.Game.Pos.SideToMove.IsWhite && !GameService.IsMate && !GameService.IsStalemate)
        {
            isBotThinking = true;
            Log("Bot's turn. Thinking...");
            StateHasChanged();
            
            // Small delay to let UI update
            Task.Delay(500).ContinueWith(async _ =>
            {
                try
                {
                    var fen = GameService.GetFen();
                    // Depth depends on skill level roughly, or fixed.
                    int depth = Math.Max(1, skillLevel / 2 + 5); 
                    
                    if (module != null)
                    {
                        Log($"Requesting move for FEN: {fen} Depth: {depth}");
                        await module.InvokeVoidAsync("requestMove", fen, depth);
                    }
                }
                catch (Exception ex)
                {
                   _ = InvokeAsync(() => Log($"Error requesting move: {ex.Message}"));
                }
            });
        }
    }

    [JSInvokable]
    public void OnBestMove(string moveString)
    {
        Log($"Bot returned move: {moveString}");
        // moveString is like "e2e4" or "e7e8q"
        if (string.IsNullOrEmpty(moveString)) return;

        var from = moveString.Substring(0, 2);
        var to = moveString.Substring(2, 2);
        
        GameService.MakeMove(from, to);
        isBotThinking = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        GameService.OnStateChanged -= OnGameStateChanged;
        if (dotNetHelper != null)
        {
            dotNetHelper.Dispose();
        }
        if (module != null)
        {
            await module.DisposeAsync();
        }
    }
}
