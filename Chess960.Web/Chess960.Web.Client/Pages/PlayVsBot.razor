@page "/play-bot"
@using Chess960.Web.Client.Services

@using Chess960.Web.Client.Components
@inject ChessGameService GameService
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Components.Web
@rendermode @(new InteractiveWebAssemblyRenderMode(prerender: false))

<PageTitle>Play vs Bot - Chess960</PageTitle>

<div class="min-h-[calc(100vh-4rem)] flex flex-col lg:flex-row">
    <!-- Board Area (Left/Center) -->
    <div class="flex-1 flex items-center justify-center p-4 lg:p-0 relative animate-in fade-in duration-700">
        <div class="relative w-full max-w-[85vh] aspect-square shadow-2xl rounded-lg overflow-hidden ring-1 ring-white/10">
                <ChessBoard />
                @if (isBotThinking)
                {
                    <!-- Transparent overlay -->
                    <div class="absolute inset-0 z-20 cursor-wait"></div>
                }
            </div>
    </div>

    <!-- Sidebar (Right) -->
    <div class="w-full lg:w-[30rem] shrink-0 p-4 lg:p-6 flex flex-col animate-slide-in-right z-20">
            
            @if (!isGameActive)
            {
                <!-- CONFIGURATION MODE -->
                <div class="glass-panel p-8 relative overflow-hidden group">
                     <!-- Decorative Bg -->
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-theme-accent/10 rounded-full blur-3xl group-hover:bg-theme-accent/20 transition-all duration-700"></div>

                    <h2 class="text-2xl font-display font-bold mb-6 text-white flex items-center gap-2 relative z-10">
                        <span class="bi bi-sliders text-theme-accent"></span> Settings
                    </h2>
                    
                    <div class="mb-8 relative z-10">
                        <label class="block text-xs font-bold text-theme-muted mb-4 uppercase tracking-wider">Strength (Engine Level)</label>
                        <div class="relative">
                            <input type="range" min="0" max="20" @bind="skillLevel" @bind:event="oninput" 
                                   class="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-theme-accent">
                        </div>
                        <div class="flex justify-between items-center mt-3">
                            <span class="text-xs text-white/50 font-bold">NOVICE</span>
                            <div class="px-4 py-1 bg-theme-accent/20 text-theme-accent rounded-full font-bold text-sm border border-theme-accent/30 shadow-[0_0_10px_rgba(var(--color-accent),0.2)]">Level @skillLevel</div>
                            <span class="text-xs text-white/50 font-bold">MASTER</span>
                        </div>
                    </div>

                    <div class="flex gap-4 relative z-10">
                        <button @onclick="StartNewGame" 
                                class="btn-pill w-full text-lg shadow-[0_0_20px_rgba(var(--color-accent),0.3)] hover:shadow-[0_0_30px_rgba(var(--color-accent),0.5)]">
                            Start Game
                        </button>
                    </div>
                </div>
            }
            else
            {
                <!-- GAME MODE -->
                <div class="glass-panel p-6 relative overflow-hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-display font-bold text-white flex items-center gap-2">
                             <span class="bi bi-robot text-theme-accent"></span> VS Stockfish
                        </h2>
                        <div class="px-3 py-1 bg-white/5 rounded-lg border border-white/10 text-xs font-mono text-theme-muted">
                            LVL @skillLevel
                        </div>
                    </div>

                    <!-- Status Display -->
                    <div class="mb-6 p-4 bg-black/40 rounded-xl border border-white/5">
                        <span class="block text-[10px] font-bold uppercase tracking-widest text-theme-muted mb-2">STATUS</span>
                        @if (isBotThinking)
                        {
                            <div class="flex items-center gap-3 text-white">
                                <div class="relative">
                                    <div class="w-3 h-3 bg-theme-accent rounded-full animate-ping absolute opacity-75"></div>
                                    <div class="w-3 h-3 bg-theme-accent rounded-full relative"></div>
                                </div>
                                <span class="font-bold text-theme-accent text-glow animate-pulse">Thinking...</span>
                            </div>
                        }
                        else if (!string.IsNullOrEmpty(GameService.GameOverMessage))
                        {
                            <div class="text-white font-bold text-sm md:text-base text-center text-balance animate-in fade-in zoom-in duration-300">
                                @GameService.GameOverMessage
                            </div>
                        }
                        else
                        {
                            <div class="flex items-center gap-3 text-theme-accent">
                                <div class="w-3 h-3 bg-theme-accent rounded-full animate-pulse"></div>
                                <span class="font-bold">Your Turn</span>
                            </div>
                        }
                    </div>

                    <!-- Controls -->
                    <div class="space-y-3">
                        @if (string.IsNullOrEmpty(GameService.GameOverMessage))
                        {
                            <button @onclick="ResignGame" class="w-full py-3 bg-red-500/10 hover:bg-red-500/20 border border-red-500/30 text-red-500 rounded-xl font-bold transition-all hover:scale-[1.02] active:scale-[0.98] uppercase text-xs tracking-wider flex items-center justify-center gap-2">
                                <span class="bi bi-flag-fill"></span> Resign
                            </button>
                        }
                        else
                        {
                            <button @onclick="StartNewGame" class="w-full py-3 bg-theme-accent hover:bg-theme-glow text-black rounded-xl font-bold transition-all hover:scale-[1.02] active:scale-[0.98] uppercase text-xs tracking-wider shadow-[0_0_15px_rgba(var(--color-accent),0.3)]">
                                New Game
                            </button>
                        }

                        <button @onclick="ExitGame" class="w-full py-3 bg-white/5 hover:bg-white/10 border border-white/10 text-theme-muted hover:text-white rounded-xl font-bold transition-all hover:scale-[1.02] active:scale-[0.98] uppercase text-xs tracking-wider">
                            Exit to Menu
                        </button>
                    </div>
                </div>
            }
    </div>
</div>

@code {
    private int skillLevel = 5;
    private bool isBotThinking = false;
    private bool isGameActive = false;
    private List<string> debugLogs = new();
    private DotNetObjectReference<PlayVsBot>? dotNetHelper;
    private IJSObjectReference? module;

    private void Log(string message)
    {
        debugLogs.Add($"{DateTime.Now:HH:mm:ss} - {message}");
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try 
            {
                Log("Initializing...");
                dotNetHelper = DotNetObjectReference.Create(this);
                // Load the script as a module
                Log("Importing module...");
                module = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "/js/stockfish-interop.js");
                Log("Module imported. Calling init...");
                await module.InvokeVoidAsync("init", dotNetHelper);
                Log("Init success.");
                
                GameService.OnStateChanged += OnGameStateChanged;
                // StartNewGame(); // Don't auto-start, wait for user configuration
            }
            catch (Exception ex)
            {
                Log($"Error during init: {ex.Message}");
            }
        }
    }

    private async void StartNewGame()
    {
        try
        {
            Log("Starting new game...");
            isGameActive = true; 
            GameService.StartNewGame(true);
            // Reset bot
            if (module != null)
            {
                await module.InvokeVoidAsync("startNewGame", skillLevel);
                Log("Bot reset.");
            }
            isBotThinking = false;
        }
        catch (Exception ex)
        {
            Log($"Error starting game: {ex.Message}");
        }
    }

    private void ResignGame()
    {
        // Locally set game over
        GameService.ResignGame("You resigned.");
        isBotThinking = false; // Stop bot from responding
        StateHasChanged();
    }

    private void ExitGame()
    {
        isGameActive = false;
        // Optionally reset game state or leave as is
        isBotThinking = false;
        StateHasChanged();
    }

    private void OnGameStateChanged()
    {
        // Check if it's Black's turn (Bot)
        if (GameService.Game != null && !GameService.Game.Pos.SideToMove.IsWhite && !GameService.IsMate && !GameService.IsStalemate)
        {
            isBotThinking = true;
            Log("Bot's turn. Thinking...");
            StateHasChanged();
            
            // Small delay to let UI update
            Task.Delay(500).ContinueWith(async _ =>
            {
                try
                {
                    var fen = GameService.GetFen();
                    // Depth depends on skill level roughly, or fixed.
                    int depth = Math.Max(1, skillLevel / 2 + 5); 
                    
                    if (module != null)
                    {
                        Log($"Requesting move for FEN: {fen} Depth: {depth}");
                        await module.InvokeVoidAsync("requestMove", fen, depth);
                    }
                }
                catch (Exception ex)
                {
                   _ = InvokeAsync(() => Log($"Error requesting move: {ex.Message}"));
                }
            });
        }
    }

    [JSInvokable]
    public void OnBestMove(string moveString)
    {
        Log($"Bot returned move: {moveString}");
        // moveString is like "e2e4" or "e7e8q"
        if (string.IsNullOrEmpty(moveString)) return;

        var from = moveString.Substring(0, 2);
        var to = moveString.Substring(2, 2);
        
        GameService.MakeMove(from, to);
        isBotThinking = false;
        StateHasChanged();
    }

    public async ValueTask DisposeAsync()
    {
        GameService.OnStateChanged -= OnGameStateChanged;
        if (dotNetHelper != null)
        {
            dotNetHelper.Dispose();
        }
        if (module != null)
        {
            await module.DisposeAsync();
        }
    }
}
