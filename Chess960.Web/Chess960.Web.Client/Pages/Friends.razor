@page "/friends"
@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Components
@using Microsoft.AspNetCore.Components.Authorization
@inject ClientFriendService FriendService
@inject MultiplayerService Multiplayer
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@implements IAsyncDisposable
@rendermode InteractiveWebAssembly

<PageTitle>Barátok | Chess960</PageTitle>

<div class="h-full px-4 md:px-8 py-6 w-full max-w-4xl mx-auto animate-soft-up">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-display font-bold text-white tracking-tight">Barátok</h1>
            <p class="text-theme-muted mt-1">Ismerősök kezelése és kihívása.</p>
        </div>
        <div class="w-12 h-12 rounded-xl bg-theme-accent/10 border border-theme-accent/30 flex items-center justify-center">
            <span class="bi bi-people-fill text-2xl text-theme-accent"></span>
        </div>
    </div>

    <!-- Friend Management (Search & Add) -->
    <div class="bg-black/20 backdrop-blur-md border border-white/5 rounded-2xl p-6 mb-8 shadow-lg">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span class="bi bi-person-plus-fill text-theme-accent"></span> Új Barát
        </h2>
        <div class="flex gap-3">
            <input @bind="friendSearchQuery" @onkeyup="@(async e => { if (e.Key == "Enter") await AddFriend(); })" type="text" placeholder="Felhasználónév keresése..." class="flex-1 bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-theme-accent transition-colors" />
            <button @onclick="AddFriend" class="bg-theme-accent text-black font-bold uppercase tracking-wider px-6 py-3 rounded-xl hover:scale-105 transition-transform shadow-[0_0_15px_rgba(var(--color-accent),0.3)]">
                <span class="bi bi-plus-lg mr-2"></span> Hozzáadás
            </button>
            <button @onclick="GenerateInviteLink" class="bg-white/10 text-white font-bold uppercase tracking-wider px-6 py-3 rounded-xl hover:bg-white/20 transition-colors">
                <span class="bi bi-link-45deg mr-2"></span> Link Generálása
            </button>
        </div>
        @if (!string.IsNullOrEmpty(friendMessage))
        {
            <div class="mt-3 text-sm font-bold @(friendMessageSuccess ? "text-green-400" : "text-red-400") animate-in fade-in slide-in-from-left-2">
                @friendMessage
            </div>
        }
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- Requests Column -->
        <div>
             <h2 class="text-xs font-bold text-theme-muted uppercase tracking-widest mb-4 flex items-center gap-2">
                 <span class="bi bi-inbox-fill"></span> Bejövő Kérések
             </h2>
             
             @if (pendingRequests.Any())
             {
                 <div class="space-y-3">
                     @foreach (var req in pendingRequests)
                     {
                         <div class="bg-white/5 border border-white/5 p-4 rounded-xl flex items-center justify-between group hover:border-theme-accent/30 transition-colors">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-theme-accent flex items-center justify-center text-black font-bold shadow-md">
                                     @req.RequesterName[0].ToString().ToUpper()
                                 </div>
                                 <div>
                                     <div class="text-white font-bold">@req.RequesterName</div>
                                     <div class="text-[10px] text-theme-muted">@req.SentAt.ToString("yyyy.MM.dd")</div>
                                 </div>
                             </div>
                             <div class="flex gap-2">
                                 <button @onclick="@(() => AcceptRequest(req.FriendshipId))" class="w-8 h-8 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-black transition-all flex items-center justify-center" title="Elfogad">
                                     <span class="bi bi-check-lg text-lg"></span>
                                 </button>
                                 <button @onclick="@(() => DeclineRequest(req.FriendshipId))" class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-black transition-all flex items-center justify-center" title="Elutasít">
                                     <span class="bi bi-x-lg"></span>
                                 </button>
                             </div>
                         </div>
                     }
                 </div>
             }
             else
             {
                 <div class="bg-white/[0.02] border border-white/5 rounded-xl p-8 text-center text-theme-muted opacity-50 border-dashed">
                     <span class="bi bi-inbox text-3xl block mb-2"></span>
                     Nincsenek új kérések
                 </div>
             }
        </div>

        <!-- Friends List Column -->
        <div>
            <h2 class="text-xs font-bold text-theme-muted uppercase tracking-widest mb-4 flex items-center gap-2">
                <span class="bi bi-people-fill"></span> Barátok Listája
            </h2>

            @if (friends.Any())
            {
                <div class="space-y-3">
                     @foreach (var friend in friends)
                     {
                         <div class="bg-white/5 border border-white/5 p-4 rounded-xl flex items-center justify-between group hover:border-theme-accent/30 transition-colors">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-theme-accent flex items-center justify-center text-black font-bold shadow-md">
                                     @friend.UserName[0].ToString().ToUpper()
                                 </div>
                                 <div>
                                     <div class="text-white font-bold">@friend.UserName</div>
                                     <div class="text-[10px] flex items-center gap-1 @(friend.Status == "Online" ? "text-green-400" : "text-white/30")">
                                         <span class="bi bi-circle-fill text-[6px]"></span> @friend.Status
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                 <select @bind="selectedTimeControl" class="bg-black/40 text-white text-xs rounded-lg px-2 py-1 border border-white/10 outline-none focus:border-theme-accent cursor-pointer">
                                     <option value="1+0">1+0</option>
                                     <option value="3+0">3+0</option>
                                     <option value="3+2">3+2</option>
                                     <option value="5+0">5 p</option>
                                     <option value="10+0">10 p</option>
                                     <option value="15+10">15|10</option>
                                 </select>
                                 <button @onclick="@(() => ChallengeFriend(friend.UserId))" class="bg-theme-accent text-black text-xs font-bold px-3 py-1.5 rounded-lg hover:scale-105 transition-transform shadow-md">
                                     Hívás
                                 </button>
                                 <button @onclick="@(() => RemoveFriend(friend.FriendshipId))" class="bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white text-xs font-bold p-1.5 rounded-lg hover:scale-105 transition-all shadow-md ml-1" title="Barát törlése">
                                     <span class="bi bi-trash-fill"></span>
                                 </button>
                             </div>
                         </div>
                     }
                </div>
            }
            else
            {
                 <div class="bg-white/[0.02] border border-white/5 rounded-xl p-8 text-center text-theme-muted opacity-50 border-dashed">
                     <span class="bi bi-emoji-frown text-3xl block mb-2"></span>
                     Még nincsenek barátaid
                 </div>
            }
        </div>
    </div>
</div>

<!-- Challenge Received Modal (Global or Page specific? Page specific for now) -->
@if (!string.IsNullOrEmpty(inviteLink))
{
    <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 animate-in fade-in duration-200" @onclick="@(() => inviteLink = null)">
        <div class="bg-[#1a1a1a] w-full max-w-md rounded-2xl shadow-2xl border border-theme-accent/30 p-8 text-center relative overflow-hidden" @onclick:stopPropagation>
             <div class="absolute top-0 left-1/2 -translate-x-1/2 w-32 h-32 bg-theme-accent/20 blur-[50px] rounded-full pointer-events-none"></div>

             <h3 class="text-2xl font-black text-white uppercase tracking-tight mb-4 flex items-center justify-center gap-2">
                 <span class="bi bi-link-45deg text-theme-accent"></span> Meghívó Link
             </h3>
             <p class="text-theme-muted mb-6">Küldd el ezt a linket a barátodnak:</p>
             
             <div class="bg-black/50 border border-white/10 rounded-xl p-4 mb-6 flex items-center gap-3">
                 <code class="text-theme-accent font-mono text-sm break-all flex-1">@inviteLink</code>
                 <button class="text-white/50 hover:text-white transition-colors" onclick="navigator.clipboard.writeText('@inviteLink')">
                     <span class="bi bi-clipboard"></span>
                 </button>
             </div>
             
             <button @onclick="@(() => inviteLink = null)" class="w-full bg-white/10 text-white font-bold py-3 rounded-xl hover:bg-white/20 transition-colors">
                 Bezárás
             </button>
        </div>
    </div>
}

@code {
    private List<FriendDto> friends = new();
    private List<FriendRequestDto> pendingRequests = new();
    private string friendSearchQuery = "";
    private string friendMessage = "";
    private bool friendMessageSuccess = false;
    private string selectedTimeControl = "3+2";
    private string CurrentUserName = "You"; // Should fetch for challenge sending

    // Challenge State removed (Moved to MainLayout)
    private string? inviteLink;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Fetch current user name if needed, or rely on Server logic
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                CurrentUserName = authState.User.Identity.Name ?? "Player";
                
                // IMPORTANT: Initialize Multiplayer connection here if not present
                if (Multiplayer.MyConnectionId == null)
                {
                     // We need UserId setup.
                     var user = authState.User;
                     var userIdClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) ?? user.FindFirst("sub");
                     if (userIdClaim != null) Multiplayer.UserId = userIdClaim.Value;
                     
                     await Multiplayer.InitializeAsync();
                }
            }
            
            // Subscribe to events
            Multiplayer.OnFriendRequestReceived += HandleFriendRequestReceived;
            
            await LoadFriends();
        }
    }

    public ValueTask DisposeAsync()
    {
        Multiplayer.OnFriendRequestReceived -= HandleFriendRequestReceived;
        
        return ValueTask.CompletedTask;
    }

    private async Task LoadFriends()
    {
        friends = await FriendService.GetFriendsAsync();
        pendingRequests = await FriendService.GetPendingRequestsAsync();
        StateHasChanged();
    }

    private async Task AddFriend()
    {
        if (string.IsNullOrWhiteSpace(friendSearchQuery)) return;
        
        var success = await FriendService.SendFriendRequestAsync(friendSearchQuery);
        if (success)
        {
            friendMessage = "Kérelem elküldve!";
            friendMessageSuccess = true;
            friendSearchQuery = "";
        }
        else
        {
            friendMessage = "Nem található felhasználó (vagy már barát).";
            friendMessageSuccess = false;
        }
    }

    private async Task AcceptRequest(int friendshipId)
    {
        await FriendService.AcceptFriendRequestAsync(friendshipId);
        await LoadFriends();
    }

    private async Task DeclineRequest(int friendshipId)
    {
        await FriendService.DeclineFriendRequestAsync(friendshipId);
        await LoadFriends();
    }

    private async Task RemoveFriend(int friendshipId)
    {
        // Simple confirm logic or immediate
        // For better UX we should ask confirmation, but for now immediate with refresh
        await FriendService.RemoveFriendAsync(friendshipId);
        await LoadFriends();
    }

    private async Task ChallengeFriend(string friendId)
    {
        await Multiplayer.SendChallengeAsync(CurrentUserName, friendId, selectedTimeControl);
        friendMessage = "Kihívás elküldve!";
        friendMessageSuccess = true;
    }
    
    private async Task GenerateInviteLink()
    {
        var gameId = await Multiplayer.CreatePrivateGameAsync(selectedTimeControl);
        if (gameId != null)
        {
            var uri = Nav.ToAbsoluteUri($"/play-online?id={gameId}");
            inviteLink = uri.ToString();
        }
    }

    private void HandleFriendRequestReceived(string requesterId, string requesterName)
    {
        // Reload friends/requests to show the new one
        InvokeAsync(LoadFriends);
        
        // Optional: Show toast?
        // friendMessage = $"{requesterName} barátnak jelölt!";
        // friendMessageSuccess = true;
        // InvokeAsync(StateHasChanged);
    }
}
