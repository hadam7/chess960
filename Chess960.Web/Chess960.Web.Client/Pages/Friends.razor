@page "/friends"
@using Chess960.Web.Client.Services
@using Chess960.Web.Client.Components
@using Microsoft.AspNetCore.Components.Authorization
@inject ClientFriendService FriendService
@inject MultiplayerService Multiplayer
@inject NavigationManager Nav
@inject AuthenticationStateProvider AuthStateProvider
@implements IAsyncDisposable
@rendermode InteractiveWebAssembly

<PageTitle>Friends | Chess960</PageTitle>

<div class="h-full px-4 md:px-8 py-6 w-full max-w-4xl mx-auto animate-soft-up">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-display font-bold text-white tracking-tight">Friends</h1>
            <p class="text-theme-muted mt-1">Manage and challenge friends.</p>
        </div>
        <div class="w-12 h-12 rounded-xl bg-theme-accent/10 border border-theme-accent/30 flex items-center justify-center">
            <span class="bi bi-people-fill text-2xl text-theme-accent"></span>
        </div>
    </div>

    <!-- Friend Management (Search & Add) -->
    <div class="bg-black/20 backdrop-blur-md border border-white/5 rounded-2xl p-6 mb-8 shadow-lg">
        <h2 class="text-lg font-bold text-white mb-4 flex items-center gap-2">
            <span class="bi bi-person-plus-fill text-theme-accent"></span> New Friend
        </h2>
        <div class="flex gap-3">
            <input @bind="friendSearchQuery" @onkeyup="@(async e => { if (e.Key == "Enter") await AddFriend(); })" type="text" placeholder="Search username..." class="flex-1 bg-black/40 border border-white/10 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-theme-accent transition-colors" />
            <button @onclick="AddFriend" class="bg-theme-accent text-black font-bold uppercase tracking-wider px-6 py-3 rounded-xl hover:scale-105 transition-transform shadow-[0_0_15px_rgba(var(--color-accent),0.3)]">
                <span class="bi bi-plus-lg mr-2"></span> Add
            </button>
        </div>
        @if (!string.IsNullOrEmpty(friendMessage))
        {
            <div class="mt-3 text-sm font-bold @(friendMessageSuccess ? "text-green-400" : "text-red-400") animate-in fade-in slide-in-from-left-2">
                @friendMessage
            </div>
        }
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
        
        <!-- Requests Column -->
        <div>
             <h2 class="text-xs font-bold text-theme-muted uppercase tracking-widest mb-4 flex items-center gap-2">
                 <span class="bi bi-inbox-fill"></span> Incoming Requests
             </h2>
             
             @if (pendingRequests.Any())
             {
                 <div class="space-y-3">
                     @foreach (var req in pendingRequests)
                     {
                         <div class="bg-white/5 border border-white/5 p-4 rounded-xl flex items-center justify-between group hover:border-theme-accent/30 transition-colors">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-theme-accent flex items-center justify-center text-black font-bold shadow-md">
                                     @((!string.IsNullOrEmpty(req.RequesterName) ? req.RequesterName[0].ToString() : "?").ToUpper())
                                 </div>
                                 <div>
                                     <div class="text-white font-bold">@req.RequesterName</div>
                                     <div class="text-[10px] text-theme-muted">@req.SentAt.ToString("yyyy.MM.dd")</div>
                                 </div>
                             </div>
                             <div class="flex gap-2">
                                 <button @onclick="@(() => AcceptRequest(req.FriendshipId))" class="w-8 h-8 rounded-lg bg-green-500/20 text-green-400 hover:bg-green-500 hover:text-black transition-all flex items-center justify-center" title="Accept">
                                     <span class="bi bi-check-lg text-lg"></span>
                                 </button>
                                 <button @onclick="@(() => DeclineRequest(req.FriendshipId))" class="w-8 h-8 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500 hover:text-black transition-all flex items-center justify-center" title="Decline">
                                     <span class="bi bi-x-lg"></span>
                                 </button>
                             </div>
                         </div>
                     }
                 </div>
             }
             else
             {
                 <div class="bg-white/[0.02] border border-white/5 rounded-xl p-8 text-center text-theme-muted opacity-50 border-dashed">
                     <span class="bi bi-inbox text-3xl block mb-2"></span>
                     No new requests
                 </div>
             }
        </div>

        <!-- Friends List Column -->
        <div>
            <h2 class="text-xs font-bold text-theme-muted uppercase tracking-widest mb-4 flex items-center gap-2">
                <span class="bi bi-people-fill"></span> Friend List
            </h2>

            @if (friends.Any())
            {
                <div class="space-y-3">
                     @foreach (var friend in friends)
                     {
                         <div class="bg-white/5 border border-white/5 p-4 rounded-xl flex items-center justify-between group hover:border-theme-accent/30 transition-colors">
                             <div class="flex items-center gap-3">
                                 <div class="w-10 h-10 rounded-full bg-theme-accent flex items-center justify-center text-black font-bold shadow-md">
                                     @((!string.IsNullOrEmpty(friend.UserName) ? friend.UserName[0].ToString() : "?").ToUpper())
                                 </div>
                                 <div>
                                     <div class="text-white font-bold">@friend.UserName</div>
                                     <div class="text-[10px] flex items-center gap-1 @(friend.Status == "Online" ? "text-green-400" : "text-white/30")">
                                         <span class="bi bi-circle-fill text-[6px]"></span> @friend.Status
                                     </div>
                                 </div>
                             </div>
                             
                             <div class="flex items-center gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                 <button @onclick="@(() => RemoveFriend(friend.FriendshipId))" class="bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white text-xs font-bold p-1.5 rounded-lg hover:scale-105 transition-all shadow-md ml-1" title="Remove Friend">
                                     <span class="bi bi-trash-fill"></span>
                                 </button>
                             </div>
                         </div>
                     }
                </div>
            }
            else
            {
                 <div class="bg-white/[0.02] border border-white/5 rounded-xl p-8 text-center text-theme-muted opacity-50 border-dashed">
                     <span class="bi bi-emoji-frown text-3xl block mb-2"></span>
                     You have no friends yet
                 </div>
            }
        </div>
    </div>
</div>



@code {
    private List<FriendDto> friends = new();
    private List<FriendRequestDto> pendingRequests = new();
    private string friendSearchQuery = "";
    private string friendMessage = "";
    private bool friendMessageSuccess = false;
    private string selectedTimeControl = "3+2";
    private string CurrentUserName = "You"; // Should fetch for challenge sending

    // Challenge State removed (Moved to MainLayout)
    private string? inviteLink;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Fetch current user name if needed, or rely on Server logic
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            if (authState.User.Identity?.IsAuthenticated == true)
            {
                CurrentUserName = authState.User.Identity.Name ?? "Player";
                
                // IMPORTANT: Initialize Multiplayer connection here if not present
                if (Multiplayer.MyConnectionId == null)
                {
                     // We need UserId setup.
                     var user = authState.User;
                     var userIdClaim = user.FindFirst(c => c.Type == System.Security.Claims.ClaimTypes.NameIdentifier) ?? user.FindFirst("sub");
                     if (userIdClaim != null) Multiplayer.UserId = userIdClaim.Value;
                     
                     await Multiplayer.InitializeAsync();
                }
            }
            
            // Subscribe to events
            Multiplayer.OnFriendRequestReceived += HandleFriendRequestReceived;
            
            await LoadFriends();
        }
    }

    public ValueTask DisposeAsync()
    {
        Multiplayer.OnFriendRequestReceived -= HandleFriendRequestReceived;
        
        return ValueTask.CompletedTask;
    }

    private async Task LoadFriends()
    {
        friends = await FriendService.GetFriendsAsync();
        pendingRequests = await FriendService.GetPendingRequestsAsync();
        StateHasChanged();
    }

    private async Task AddFriend()
    {
        if (string.IsNullOrWhiteSpace(friendSearchQuery)) return;
        
        var error = await FriendService.SendFriendRequestAsync(friendSearchQuery);
        if (error == null) // Success
        {
            friendMessage = "Request sent!";
            friendMessageSuccess = true;
            friendSearchQuery = "";
        }
        else
        {
            friendMessage = error;
            friendMessageSuccess = false;
        }
    }

    private async Task AcceptRequest(int friendshipId)
    {
        await FriendService.AcceptFriendRequestAsync(friendshipId);
        await LoadFriends();
    }

    private async Task DeclineRequest(int friendshipId)
    {
        await FriendService.DeclineFriendRequestAsync(friendshipId);
        await LoadFriends();
    }

    private async Task RemoveFriend(int friendshipId)
    {
        // Simple confirm logic or immediate
        // For better UX we should ask confirmation, but for now immediate with refresh
        await FriendService.RemoveFriendAsync(friendshipId);
        await LoadFriends();
    }



    private void HandleFriendRequestReceived(string requesterId, string requesterName)
    {
        // Reload friends/requests to show the new one
        InvokeAsync(LoadFriends);
        
        // Optional: Show toast?
        // friendMessage = $"{requesterName} barátnak jelölt!";
        // friendMessageSuccess = true;
        // InvokeAsync(StateHasChanged);
    }
}
