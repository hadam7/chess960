@page "/Account/ForgotPassword"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using Chess960.Web.Data

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Elfelejtett jelszó?</PageTitle>

<div class="min-h-screen flex items-center justify-center p-4">
    <div class="w-full max-w-md bg-black/40 backdrop-blur-xl border border-white/10 rounded-2xl p-8 shadow-2xl relative overflow-hidden group">
        <!-- Glow Effect -->
        <div class="absolute -top-20 -right-20 w-40 h-40 bg-theme-accent/20 rounded-full blur-3xl group-hover:bg-theme-accent/30 transition-all duration-1000"></div>
        
        <div class="relative z-10">
            <h1 class="text-3xl font-bold bg-gradient-to-r from-white to-white/60 bg-clip-text text-transparent mb-2 font-display text-center">Új jelszó kérése</h1>
            <h2 class="text-sm text-theme-muted text-center mb-8">Add meg az e-mail címedet.</h2>

            <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post" class="space-y-6">
                <DataAnnotationsValidator />
                <ValidationSummary class="text-red-500 bg-red-500/10 p-3 rounded-lg text-sm mb-4" role="alert" />

                <div class="space-y-2">
                    <label for="Input.Email" class="block text-xs font-bold uppercase tracking-wider text-theme-muted ml-1">Email cím</label>
                    <InputText @bind-Value="Input.Email" id="Input.Email" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-white placeholder-white/20 focus:outline-none focus:border-theme-accent/50 focus:bg-white/10 transition-all font-sans" autocomplete="username" aria-required="true" placeholder="nev@pelda.hu" />
                    <ValidationMessage For="() => Input.Email" class="text-xs text-red-400 ml-1" />
                </div>

                <button type="submit" class="w-full bg-theme-accent hover:bg-theme-glow text-black font-bold py-3.5 rounded-xl transition-all shadow-[0_0_15px_rgba(var(--color-accent),0.2)] hover:shadow-[0_0_25px_rgba(var(--color-accent),0.4)] hover:scale-[1.02] active:scale-[0.98] uppercase tracking-wide text-sm">
                    Jelszóvisszaállító link küldése
                </button>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    private async Task OnValidSubmitAsync()
    {
        var user = await UserManager.FindByEmailAsync(Input.Email);
        if (user is null || !(await UserManager.IsEmailConfirmedAsync(user)))
        {
            // Don't reveal that the user does not exist or is not confirmed
            RedirectManager.RedirectTo("Account/ForgotPasswordConfirmation");
        }

        // For more information on how to enable account confirmation and password reset please
        // visit https://go.microsoft.com/fwlink/?LinkID=532713
        var code = await UserManager.GeneratePasswordResetTokenAsync(user);
        code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
        var callbackUrl = NavigationManager.GetUriWithQueryParameters(
            NavigationManager.ToAbsoluteUri("Account/ResetPassword").AbsoluteUri,
            new Dictionary<string, object?> { ["code"] = code });

        await EmailSender.SendPasswordResetLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));

        RedirectManager.RedirectTo("Account/ForgotPasswordConfirmation");
    }

    private sealed class InputModel
    {
        [Required(ErrorMessage = "Az email cím megadása kötelező.")]
        [EmailAddress(ErrorMessage = "Érvénytelen email formátum.")]
        public string Email { get; set; } = "";
    }
}
